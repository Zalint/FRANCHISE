<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord Temps R√©el - Keur BALLI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
            --primary-color: #dc3545;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .header-card h1 {
            margin: 0;
            color: var(--primary-color);
            font-size: 28px;
            font-weight: 700;
        }

        .header-card .subtitle {
            color: #6c757d;
            font-size: 14px;
            margin-top: 5px;
        }

        .content-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .ventes-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            position: relative;
            height: 400px;
        }

        .stock-table {
            width: 100%;
            font-size: 13px;
        }

        .stock-table thead {
            background: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .stock-table th {
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        .stock-table td {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
            cursor: help;
            position: relative;
        }

        .stock-value {
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
            min-width: 50px;
        }

        .stock-high {
            background: #d1fae5;
            color: #059669;
        }

        .stock-medium {
            background: #fed7aa;
            color: #ea580c;
        }

        .stock-low {
            background: #fecaca;
            color: #dc2626;
        }

        /* Tooltip personnalis√© */
        .custom-tooltip {
            position: absolute;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 280px;
            display: none;
            font-size: 13px;
            pointer-events: none;
        }

        .custom-tooltip.show {
            display: block;
        }

        .tooltip-header {
            font-size: 14px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }

        .tooltip-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .tooltip-row:last-child {
            border-bottom: none;
            padding-top: 10px;
            margin-top: 8px;
            border-top: 2px solid #e5e7eb;
            font-weight: 700;
        }

        .tooltip-label {
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tooltip-value {
            color: #1f2937;
            font-weight: 600;
        }

        .update-badge {
            background: #10b981;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #6b7280;
            font-size: 13px;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 50px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn-group .btn {
            margin-left: 10px;
        }

        @media (max-width: 1200px) {
            .content-grid {
                /* D√©j√† en mode vertical, pas de changement n√©cessaire */
            }
        }

        .stock-table-container {
            max-height: 500px;
            overflow-y: auto;
        }

        .pdv-row {
            background: white;
            transition: background 0.2s;
        }

        .pdv-row:hover {
            background: #f8f9fa;
        }

        .transfer-detail {
            font-size: 11px;
            color: #6c757d;
            margin-left: 15px;
        }

        .update-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 10px;
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 12px;
            color: #374151;
        }

        .update-badge .pdv-name {
            font-weight: 600;
            color: #1f2937;
        }

        .update-badge .time {
            color: #059669;
            font-weight: 500;
        }

        /* Section Collapsible Packs */
        .collapsible-header {
            cursor: pointer;
            user-select: none;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .collapsible-header:hover {
            opacity: 0.8;
        }

        .collapsible-toggle {
            transition: transform 0.3s;
            font-size: 18px;
        }

        .collapsible-toggle.expanded {
            transform: rotate(180deg);
        }
        
        /* Client details accordion styles */
        .client-accordion-header {
            transition: background-color 0.2s ease;
        }
        
        .client-accordion-header:hover {
            background-color: rgba(16, 185, 129, 0.1) !important;
        }
        
        .client-details-content {
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.expanded {
            max-height: 2000px;
        }
        
        /* AI Interpretation section needs more space */
        #ai-interpretation-collapsible.expanded {
            max-height: 4000px;
            overflow-y: auto;
        }

        /* Audio button styles */
        #btn-audio-play {
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        #btn-audio-play:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        #btn-audio-play.btn-danger {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Collapsible PDV cards animation */
        .card-header[data-bs-toggle="collapse"] {
            transition: all 0.3s ease;
        }
        
        .card-header[data-bs-toggle="collapse"]:hover {
            opacity: 0.9;
        }
        
        .card-header .bi-chevron-down {
            transition: transform 0.3s ease;
        }
        
        .card-header[aria-expanded="false"] .bi-chevron-down {
            transform: rotate(0deg);
        }
        
        .card-header[aria-expanded="true"] .bi-chevron-down {
            transform: rotate(180deg);
        }
        
        /* Tooltip styling */
        .tooltip-inner {
            max-width: 350px;
            text-align: left;
            padding: 10px 15px;
            font-size: 0.9rem;
            background-color: #2d3748;
        }
        
        .tooltip.show {
            opacity: 1;
        }
        
        /* Hover effect for badges with tooltips */
        .badge[data-bs-toggle="tooltip"] {
            transition: all 0.2s ease;
            position: relative;
        }
        
        .badge[data-bs-toggle="tooltip"]:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .badge[data-bs-toggle="tooltip"]::after {
            content: '?';
            position: absolute;
            top: -5px;
            right: -5px;
            background: white;
            color: #856404;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #856404;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="header-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1>üìä Tableau de Bord Temps R√©el</h1>
                    <div class="subtitle">Keur BALLI - Vue d'ensemble des ventes et stocks</div>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label for="date-selector" style="font-weight: 500; color: #4b5563; white-space: nowrap;">üìÖ Date :</label>
                        <input 
                            type="date" 
                            id="date-selector" 
                            class="form-control form-control-sm" 
                            style="width: 150px;"
                            onchange="handleDateChange()"
                        />
                    </div>
                    <div class="auto-refresh">
                        <i class="bi bi-clock-history"></i>
                        <span id="countdown">Prochaine MAJ dans <strong id="countdown-timer">30s</strong></span>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="window.location.href='pos.html'">
                        <i class="bi bi-shop"></i> Mode POS
                    </button>
                    <button class="btn btn-success btn-sm" onclick="location.reload()">
                        <i class="bi bi-arrow-repeat"></i> Rafra√Æchir
                    </button>
                    <a href="/" class="btn btn-secondary btn-sm">
                        <i class="bi bi-arrow-left"></i> Retour
                    </a>
                </div>
            </div>
        </div>

        <!-- Derni√®res mises √† jour par point de vente -->
        <div class="header-card" style="margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                <i class="bi bi-clock-history text-primary"></i>
                <h6 style="margin: 0; font-weight: 600; color: #1f2937;">Derni√®res Mises √† Jour des Ventes</h6>
            </div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <div>
                    <div id="ventes-updates-container" style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <span style="color: #6c757d; font-size: 13px;">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Grid -->
        <div class="content-grid">
            <!-- ü§ñ AI Sales Interpretation - REMOVED -->
            <div class="card-section" style="display:none;">
                <div class="collapsible-content expanded" id="ai-interpretation-collapsible">
                    <div class="text-center mb-3">
                        <!-- Model selector -->
                        <div class="mb-3">
                            <label for="ai-model-select" class="form-label" style="font-weight: 600;">
                                <i class="bi bi-cpu"></i> Mod√®le OpenAI
                            </label>
                            <select id="ai-model-select" class="form-select" style="max-width: 300px; margin: 0 auto;">
                                <option value="gpt-4o-mini" selected>GPT-4o Mini (Rapide & √âconomique)</option>
                                <option value="gpt-4o">GPT-4o (Recommand√© - Plus puissant)</option>
                                <option value="gpt-4">GPT-4 (Maximum qualit√©)</option>
                            </select>
                            <small class="text-muted d-block mt-1">
                                Choisissez le mod√®le selon vos besoins: vitesse vs qualit√©
                            </small>
                        </div>
                        
                        <!-- Threshold and Top Client settings -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="ai-threshold-input" class="form-label" style="font-weight: 600;">
                                    <i class="bi bi-cash-stack"></i> Seuil Gros Client
                                </label>
                                <input type="number" id="ai-threshold-input" class="form-control" 
                                       value="120000" min="0" step="5000" placeholder="120000"
                                       onchange="checkAICacheStatus()">
                                <small class="text-muted d-block mt-1">
                                    Montant minimum pour identifier un gros client (FCFA)
                                </small>
                            </div>
                            <div class="col-md-6">
                                <label for="ai-top-clients-input" class="form-label" style="font-weight: 600;">
                                    <i class="bi bi-trophy-fill"></i> Top Clients
                                </label>
                                <input type="number" id="ai-top-clients-input" class="form-control" 
                                       value="10" min="1" max="50" step="1" placeholder="10"
                                       onchange="checkAICacheStatus()">
                                <small class="text-muted d-block mt-1">
                                    Nombre de meilleurs clients √† afficher
                                </small>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2 justify-content-center">
                            <button 
                                id="btn-ai-analyze" 
                                class="btn btn-primary btn-lg" 
                                onclick="runAIInterpretation(false)"
                                style="border-radius: 10px; padding: 12px 30px;">
                                <i class="bi bi-robot"></i> <span id="btn-ai-text">Lancer l'Analyse IA</span>
                            </button>
                            <button 
                                id="btn-ai-force" 
                                class="btn btn-outline-secondary" 
                                onclick="runAIInterpretation(true)"
                                style="border-radius: 10px; padding: 12px 20px; display: none;"
                                title="Forcer une nouvelle analyse (ignorer le cache)">
                                <i class="bi bi-arrow-clockwise"></i> Nouvelle Analyse
                            </button>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> Analyse combin√©e: ventes + satisfaction clients
                            </small>
                            <div id="ai-cache-info" class="mt-1" style="display: none;">
                                <small class="text-success">
                                    <i class="bi bi-check-circle"></i> Analyse en cache
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div id="ai-loading" style="display: none;">
                        <div class="loading-spinner"></div>
                        <p class="text-center text-muted mt-3">
                            <i class="bi bi-hourglass-split"></i> <span id="ai-loading-text">Analyse en cours...</span>
                        </p>
                        <p class="text-center text-muted" style="font-size: 0.85rem;">
                            <span id="ai-loading-details">R√©cup√©ration des donn√©es...</span>
                        </p>
                    </div>
                    
                    <div id="ai-results" style="display: none;">
                        <!-- Global Analysis -->
                        <div class="alert alert-primary" style="border-radius: 10px;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5><i class="bi bi-graph-up-arrow"></i> Analyse Globale</h5>
                                    <span id="ai-model-badge" class="badge bg-secondary" style="font-size: 0.7rem;"></span>
                                    <div id="ai-metrics" class="mt-2" style="font-size: 0.8rem; color: #6c757d;"></div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button 
                                        id="btn-audio-play" 
                                        class="btn btn-sm btn-outline-primary" 
                                        onclick="toggleAudioReading()"
                                        title="√âcouter l'analyse">
                                        <i class="bi bi-volume-up-fill"></i> √âcouter
                                    </button>
                                    <button 
                                        id="btn-export-text" 
                                        class="btn btn-sm btn-outline-success" 
                                        onclick="exportAnalysisToText()"
                                        title="Exporter en fichier texte">
                                        <i class="bi bi-file-text"></i> Exporter
                                    </button>
                                </div>
                            </div>
                            <p id="ai-global-analysis" style="margin-bottom: 0;"></p>
                        </div>
                        
                        <!-- 5 Niveaux d'Humeurs (identique au POS) -->
                        <div class="row mb-3">
                            <div class="col">
                                <div class="card text-center" style="border: 2px solid #10b981; border-radius: 10px; background: linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%);">
                                    <div class="card-body py-2">
                                        <h3 class="mb-0" style="color: #10b981;" id="ai-excellent-count">0</h3>
                                        <small class="text-muted">üíö Excellent</small>
                                        <div style="font-size: 0.7rem; color: #6b7280;">&gt; 9/10</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="card text-center" style="border: 2px solid #3b82f6; border-radius: 10px; background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);">
                                    <div class="card-body py-2">
                                        <h3 class="mb-0" style="color: #3b82f6;" id="ai-very-happy-count">0</h3>
                                        <small class="text-muted">üòä Tr√®s satisfait</small>
                                        <div style="font-size: 0.7rem; color: #6b7280;">8-9/10</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="card text-center" style="border: 2px solid #f59e0b; border-radius: 10px; background: linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%);">
                                    <div class="card-body py-2">
                                        <h3 class="mb-0" style="color: #f59e0b;" id="ai-happy-count">0</h3>
                                        <small class="text-muted">üòê Satisfait</small>
                                        <div style="font-size: 0.7rem; color: #6b7280;">7-8/10</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="card text-center" style="border: 2px solid #f97316; border-radius: 10px; background: linear-gradient(135deg, #fed7aa 0%, #ffedd5 100%);">
                                    <div class="card-body py-2">
                                        <h3 class="mb-0" style="color: #f97316;" id="ai-unhappy-count">0</h3>
                                        <small class="text-muted">üò† Insatisfait</small>
                                        <div style="font-size: 0.7rem; color: #6b7280;">6-7/10</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="card text-center" style="border: 2px solid #ef4444; border-radius: 10px; background: linear-gradient(135deg, #fecaca 0%, #fee2e2 100%);">
                                    <div class="card-body py-2">
                                        <h3 class="mb-0" style="color: #ef4444;" id="ai-very-unhappy-count">0</h3>
                                        <small class="text-muted">üò° Tr√®s insatisfait</small>
                                        <div style="font-size: 0.7rem; color: #6b7280;">‚â§ 6/10</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        
                        <!-- Top Clients Section - COLLAPSIBLE -->
                        <div id="ai-top-clients" style="display: none;">
                            <div class="alert alert-success" style="border-radius: 10px; border-left: 4px solid #10b981;">
                                <div class="d-flex justify-content-between align-items-center" style="cursor: pointer;" onclick="toggleTopClients()">
                                    <h5 class="mb-0"><i class="bi bi-trophy-fill"></i> Top Clients du Jour</h5>
                                    <span class="collapsible-toggle expanded" id="top-clients-toggle">‚ñ≤</span>
                                </div>
                                <div id="ai-top-clients-container" class="mt-3">
                                    <div id="ai-top-clients-list"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Unhappy Clients Alert - COLLAPSIBLE -->
                        <div id="ai-unhappy-clients" style="display: none;">
                            <div class="alert alert-warning" style="border-radius: 10px;">
                                <div class="d-flex justify-content-between align-items-center" style="cursor: pointer;" onclick="toggleUnhappyClients()">
                                    <h5 class="mb-0"><i class="bi bi-exclamation-triangle-fill"></i> Clients √† Surveiller</h5>
                                    <span class="collapsible-toggle expanded" id="unhappy-clients-toggle">‚ñ≤</span>
                                </div>
                                <div id="ai-unhappy-list-container" class="mt-3">
                                    <div id="ai-unhappy-list"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Comments Sentiment Analysis -->
                        <div id="ai-comments-section" style="display: none;">
                            <div class="alert alert-info" style="border-radius: 10px; border-left: 4px solid #17a2b8;">
                                <h5><i class="bi bi-chat-left-quote-fill"></i> Analyse des Commentaires Clients</h5>
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <div class="text-center p-2" style="background: white; border-radius: 8px;">
                                            <h4 id="ai-comments-total" class="mb-0 text-info">0</h4>
                                            <small class="text-muted">üí¨ Commentaires</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center p-2" style="background: white; border-radius: 8px;">
                                            <h4 id="ai-comments-positive" class="mb-0 text-success">0</h4>
                                            <small class="text-muted">üòä Positifs</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center p-2" style="background: white; border-radius: 8px;">
                                            <h4 id="ai-comments-negative" class="mb-0 text-danger">0</h4>
                                            <small class="text-muted">üòû N√©gatifs</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center p-2" style="background: white; border-radius: 8px;">
                                            <h4 id="ai-comments-neutral" class="mb-0 text-secondary">0</h4>
                                            <small class="text-muted">üòê Neutres</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="d-flex align-items-center mb-2">
                                        <strong>Sentiment Global:</strong>
                                        <span id="ai-comments-overall" class="badge bg-secondary ms-2">-</span>
                                    </div>
                                    <div style="background: white; padding: 12px; border-radius: 8px;">
                                        <p id="ai-comments-summary" class="mb-0" style="font-size: 14px;"></p>
                                    </div>
                                </div>
                                
                                <div id="ai-comments-themes" style="display: none;">
                                    <strong>Th√®mes Cl√©s:</strong>
                                    <div id="ai-comments-themes-list" class="mt-2"></div>
                                </div>
                                
                                <div class="mt-3">
                                    <button class="btn btn-sm btn-outline-info" onclick="toggleCommentsList()">
                                        <i class="bi bi-list-ul"></i> <span id="comments-toggle-text">Voir les commentaires</span>
                                    </button>
                                </div>
                                
                                <div id="ai-comments-list" style="display: none;" class="mt-3">
                                    <div style="background: white; padding: 12px; border-radius: 8px; max-height: 400px; overflow-y: auto;">
                                        <div id="ai-comments-list-content"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- By Point de Vente -->
                        <div class="mt-4">
                            <h5><i class="bi bi-shop"></i> Analyse par Point de Vente</h5>
                            <div id="ai-pdv-analyses"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ventes par PDV - COLLAPSIBLE -->
            <div class="card-section">
                <div class="collapsible-header" onclick="toggleSection('ventes')">
                    <div class="section-title" style="margin-bottom: 0;">
                        <i class="bi bi-bar-chart-fill text-primary"></i>
                        Ventes par Point de Vente
                    </div>
                    <div>
                        <span class="collapsible-toggle expanded" id="ventes-toggle">‚ñ≤</span>
                    </div>
                </div>
                <div class="collapsible-content expanded" id="ventes-collapsible">
                    <div id="loading-ventes" class="loading-spinner"></div>
                    <div id="ventes-content" style="display: none;">
                        <div class="chart-container">
                            <canvas id="ventesChart"></canvas>
                        </div>
                        <div class="mt-3 text-center">
                            <h4 class="text-primary mb-0">Total du jour</h4>
                            <h2 class="text-success" id="total-ventes">0 FCFA</h2>
                            <small class="text-muted" id="derniere-maj-ventes">-</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ventes Packs (Composition) - COLLAPSIBLE -->
            <div class="card-section">
                <div class="collapsible-header" onclick="toggleSection('packs')">
                    <div class="section-title" style="margin-bottom: 0;">
                        <i class="bi bi-box-seam-fill text-warning"></i>
                        Ventes Packs (Impact Stock)
                    </div>
                    <div>
                        <span class="collapsible-toggle expanded" id="packs-toggle">‚ñ≤</span>
                    </div>
                </div>
                <div class="collapsible-content expanded" id="packs-collapsible">
                    <div id="loading-packs" class="loading-spinner"></div>
                    <div id="packs-content" style="display: none;">
                        <div id="packs-table-container" style="overflow-x: auto;">
                            <table class="table table-sm" style="font-size: 13px;">
                                <thead style="background: #f8f9fa;">
                                    <tr>
                                        <th>Point de Vente</th>
                                        <th class="text-center">Packs Vendus</th>
                                        <th class="text-center">Boeuf (kg)</th>
                                        <th class="text-center">Veau (kg)</th>
                                        <th class="text-center">Agneau (kg)</th>
                                        <th class="text-center">Poulet (pcs)</th>
                                        <th class="text-end">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="packs-tbody">
                                    <!-- Rempli par JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3 text-center">
                            <small class="text-muted">üí° Ces quantit√©s impactent le stock de chaque produit</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Commandes Pay√©es - COLLAPSIBLE -->
            <div class="card-section">
                <div class="collapsible-header" onclick="toggleSection('paiements')">
                    <div class="section-title" style="margin-bottom: 0;">
                        <i class="bi bi-credit-card-fill text-success"></i>
                        Commandes Pay√©es
                    </div>
                    <div>
                        <span class="collapsible-toggle expanded" id="paiements-toggle">‚ñ≤</span>
                    </div>
                </div>
                <div class="collapsible-content expanded" id="paiements-collapsible">
                    <div id="loading-paiements" class="loading-spinner"></div>
                    <div id="paiements-content" style="display: none;">
                        <div class="chart-container" style="height: 400px;">
                            <canvas id="paiementsChart"></canvas>
                        </div>
                        <div class="mt-3 text-center">
                            <h4 class="text-success mb-0">Total Commandes</h4>
                            <h2 class="text-primary" id="total-paiements">0 FCFA</h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stock temps r√©el - COLLAPSIBLE -->
            <div class="card-section">
                <div class="collapsible-header" onclick="toggleSection('stock')">
                    <div class="section-title" style="margin-bottom: 0;">
                        <i class="bi bi-box-seam text-success"></i>
                        Stock Temps R√©el par Point de Vente
                    </div>
                    <div>
                        <span class="collapsible-toggle expanded" id="stock-toggle">‚ñ≤</span>
                    </div>
                </div>
                <div class="collapsible-content expanded" id="stock-collapsible">
                    <div id="loading-stock" class="loading-spinner"></div>
                    <div id="stock-content" style="display: none;">
                        <div class="stock-table-container">
                            <table class="stock-table table table-hover">
                                <thead>
                                    <tr>
                                        <th style="text-align: left;">Point de Vente</th>
                                        <th>Boeuf</th>
                                        <th>Veau</th>
                                        <th>Agneau</th>
                                        <th>Poulet</th>
                                        <th>Yell</th>
                                        <th>V.Hach√©e</th>
                                        <th>Mergez</th>
                                        <th>Laxass</th>
                                        <th>Poisson</th>
                                    </tr>
                                </thead>
                                <tbody id="stock-tbody">
                                    <!-- Les donn√©es seront ins√©r√©es ici -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3 text-center">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> 
                                Survolez les valeurs pour voir le d√©tail (stock matin, transferts, ventes)
                            </small>
                        </div>
                        <div class="mt-2 d-flex justify-content-center gap-3">
                            <span class="badge bg-success">üü¢ > 30 kg</span>
                            <span class="badge bg-warning text-dark">üü° 10-30 kg</span>
                            <span class="badge bg-danger">üî¥ &lt; 10 kg</span>
                        </div>
                        <div class="mt-2 text-center">
                            <small class="text-muted" id="derniere-maj-stock">-</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Commandes Web du jour - REMOVED -->
        </div>
    </div>

    <!-- Tooltip personnalis√© -->
    <div id="custom-tooltip" class="custom-tooltip"></div>

    <!-- Modal Texte WebOrder -->
    <div class="modal fade" id="webOrderTexteModalRealtime" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h5 class="modal-title"><i class="bi bi-file-text"></i> Texte de la commande</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; white-space: pre-wrap; font-family: monospace; font-size: 0.9rem; user-select: text; -webkit-user-select: text;">
                    <div id="webOrderTexteContentRealtime"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="copierTexteWebOrderRealtime()">
                        <i class="bi bi-clipboard"></i> Copier tout
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour afficher les clients par humeur -->
    <div class="modal fade" id="moodClientsModal" tabindex="-1" aria-labelledby="moodClientsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h5 class="modal-title" id="moodClientsModalLabel">
                        <span id="modal-mood-emoji"></span> 
                        <span id="modal-mood-label"></span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="modal-clients-list"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Historique Client (Realtime) -->
    <div class="modal fade" id="historiqueClientRealtimeModal" tabindex="-1" aria-labelledby="historiqueClientRealtimeLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); color: white;">
                    <h5 class="modal-title" id="historiqueClientRealtimeLabel">
                        <i class="fas fa-history me-2"></i>
                        <span id="histRt-nomClient">Client</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <!-- Infos r√©sum√©es -->
                    <div class="p-3" style="background: #f8f4ff; border-bottom: 1px solid #e9d5ff;">
                        <div class="d-flex align-items-center gap-3 flex-wrap">
                            <span><i class="bi bi-telephone text-primary"></i> <strong id="histRt-phone">-</strong></span>
                            <span class="badge bg-secondary" id="histRt-totalCommandes">0 commande(s)</span>
                            <span class="text-muted" style="font-size:13px;">
                                Premi√®re: <strong id="histRt-firstOrder">-</strong> &nbsp;|&nbsp; Derni√®re: <strong id="histRt-lastOrder">-</strong>
                            </span>
                        </div>
                    </div>
                    <!-- Loading -->
                    <div id="histRt-loading" class="text-center p-4">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-muted">Chargement de l'historique...</p>
                    </div>
                    <!-- Contenu -->
                    <div id="histRt-content" class="p-3" style="display:none; max-height: 500px; overflow-y: auto;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let ventesChart = null;
        let paiementsChart = null;
        let autoRefreshInterval = null;
        let countdownInterval = null;
        let secondsRemaining = 900; // 15 minutes = 900 secondes
        let nextUpdateTime = null;
        let selectedDate = null; // Date s√©lectionn√©e (null = aujourd'hui)

        // Fonction pour √©chapper les caract√®res HTML (s√©curit√© XSS)
        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // Fonction pour obtenir la date s√©lectionn√©e ou aujourd'hui
        function getSelectedDate() {
            if (selectedDate) {
                return selectedDate;
            }
            const today = new Date();
            return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        }

        // G√©rer le changement de date
        function handleDateChange() {
            const dateInput = document.getElementById('date-selector');
            selectedDate = dateInput.value; // Format YYYY-MM-DD
            console.log('üìÖ Date s√©lectionn√©e:', selectedDate);
            
            // Recharger les donn√©es
            loadData();
            
            // Mettre √† jour le titre si ce n'est pas aujourd'hui
            updateTitle();
        }

        // Mettre √† jour le titre avec la date s√©lectionn√©e
        function updateTitle() {
            const subtitle = document.querySelector('.subtitle');
            const currentDate = getSelectedDate();
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            
            if (currentDate === todayStr) {
                subtitle.textContent = 'Keur BALLI - Vue d\'ensemble des ventes et stocks';
            } else {
                const dateObj = new Date(currentDate + 'T00:00:00');
                const formattedDate = dateObj.toLocaleDateString('fr-FR', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                subtitle.textContent = `Keur BALLI - Donn√©es du ${formattedDate}`;
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialiser le s√©lecteur de date √† aujourd'hui
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            document.getElementById('date-selector').value = todayStr;
            
            // Initialiser l'affichage du compte √† rebours
            updateCountdownDisplay();
            
            const isAuthorized = await checkAuth();
            if (isAuthorized) {
                loadData();
                startAutoRefresh();
                startCountdown();
            }
        });

        // V√©rifier l'authentification
        async function checkAuth() {
            try {
                const response = await fetch('/api/check-session', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();

                if (!result.success || !result.user) {
                    window.location.href = '/login.html';
                    return false;
                }

                const userRole = result.user.role;
                
                // V√©rifier les permissions
                // G√©rer les deux cas (majuscule et minuscule) pour √©viter les r√©gressions
                if (userRole !== 'superviseur' && userRole !== 'SuperUtilisateur' && userRole !== 'superutilisateur') {
                    alert('‚ùå Acc√®s refus√©. Ce tableau de bord est r√©serv√© aux Superviseurs et SuperUtilisateurs.');
                    window.location.href = '/';
                    return false;
                }

                console.log('‚úÖ Acc√®s autoris√© pour:', userRole);
                return true;
            } catch (error) {
                console.error('Erreur v√©rification auth:', error);
                window.location.href = '/login.html';
                return false;
            }
        }

        // Charger toutes les donn√©es
        async function loadData() {
            // Check AI cache status when date changes
            try {
                checkAICacheStatus();
            } catch (e) {
                // Function might not be loaded yet
            }
            
            await Promise.all([
                loadLastUpdates(),
                loadVentesData(),
                loadPaiementsData(),
                loadStockData(),
                loadPackSalesCompositionData()
            ]);
        }

        // Charger les derni√®res mises √† jour par point de vente
        async function loadLastUpdates() {
            console.log('üïê [FRONTEND] ========== D√âBUT loadLastUpdates ==========');
            try {
                const selectedDateParam = getSelectedDate();
                const url = `/api/realtime/last-updates?date=${selectedDateParam}`;
                
                console.log('üïê [FRONTEND] URL appel√©e:', url);
                console.log('üïê [FRONTEND] Date s√©lectionn√©e:', selectedDateParam);
                console.log('üïê [FRONTEND] Envoi de la requ√™te...');
                
                const response = await fetch(url, {
                    credentials: 'include'
                });

                console.log('üïê [FRONTEND] R√©ponse re√ßue - Status:', response.status);
                console.log('üïê [FRONTEND] R√©ponse re√ßue - OK:', response.ok);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå [FRONTEND] Erreur HTTP:', response.status);
                    console.error('‚ùå [FRONTEND] Texte erreur:', errorText);
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                console.log('üïê [FRONTEND] R√©sultat API last-updates:', result);
                console.log('üïê [FRONTEND] Success:', result.success);
                console.log('üïê [FRONTEND] Data:', result.data);

                if (result.success && result.data) {
                    console.log('üïê [FRONTEND] Ventes:', result.data.ventes);
                    console.log('üïê [FRONTEND] Appel displayLastUpdates...');
                    displayLastUpdates(result.data);
                    console.log('‚úÖ [FRONTEND] displayLastUpdates termin√©');
                } else {
                    console.warn('‚ö†Ô∏è [FRONTEND] Pas de donn√©es disponibles');
                    document.getElementById('ventes-updates-container').innerHTML = 
                        '<span style="color: #dc3545; font-size: 13px;">Aucune donn√©e disponible</span>';
                }
                
                console.log('üïê [FRONTEND] ========== FIN loadLastUpdates ==========');
            } catch (error) {
                console.error('‚ùå [FRONTEND] ========== ERREUR loadLastUpdates ==========');
                console.error('‚ùå [FRONTEND] Type:', error.constructor.name);
                console.error('‚ùå [FRONTEND] Message:', error.message);
                console.error('‚ùå [FRONTEND] Stack:', error.stack);
                console.error('‚ùå [FRONTEND] Erreur chargement last-updates:', error);
                console.error('‚ùå [FRONTEND] ========== FIN ERREUR ==========');
                
                document.getElementById('ventes-updates-container').innerHTML = 
                    '<span style="color: #dc3545; font-size: 13px;">Erreur de chargement</span>';
            }
        }

        // Afficher les derni√®res mises √† jour
        function displayLastUpdates(data) {
            console.log('üì∫ [DISPLAY] ========== D√âBUT displayLastUpdates ==========');
            console.log('üì∫ [DISPLAY] Data re√ßue:', data);
            
            const ventesContainer = document.getElementById('ventes-updates-container');
            
            console.log('üì∫ [DISPLAY] Container Ventes:', ventesContainer);
            
            // Afficher les ventes
            console.log('üì∫ [DISPLAY] Traitement des ventes...');
            console.log('üì∫ [DISPLAY] Nombre de PDV avec ventes:', Object.keys(data.ventes).length);
            
            if (Object.keys(data.ventes).length === 0) {
                console.log('üì∫ [DISPLAY] Aucune vente trouv√©e');
                ventesContainer.innerHTML = '<span style="color: #6c757d; font-size: 12px;">Aucune vente pour cette date</span>';
            } else {
                const sortedVentes = Object.entries(data.ventes).sort((a, b) => a[0].localeCompare(b[0]));
                console.log('üì∫ [DISPLAY] Ventes tri√©es:', sortedVentes);
                
                const ventesHTML = sortedVentes.map(([pdv, lastUpdate]) => {
                    const updateDate = new Date(lastUpdate);
                    // Utiliser les heures UTC (sans conversion en heure locale)
                    const hours = String(updateDate.getUTCHours()).padStart(2, '0');
                    const minutes = String(updateDate.getUTCMinutes()).padStart(2, '0');
                    const timeStr = `${hours}:${minutes}`;
                    
                    console.log(`üì∫ [DISPLAY] Vente - PDV: ${pdv}, LastUpdate: ${lastUpdate}, Time UTC: ${timeStr}`);
                    
                    return `
                        <div class="update-badge">
                            <span class="pdv-name">${escapeHtml(pdv)}</span>
                            <span class="time">${timeStr}</span>
                        </div>
                    `;
                }).join('');
                
                console.log('üì∫ [DISPLAY] HTML Ventes g√©n√©r√© (length):', ventesHTML.length);
                ventesContainer.innerHTML = ventesHTML;
                console.log('üì∫ [DISPLAY] HTML Ventes inject√©');
            }
            
            console.log('üì∫ [DISPLAY] ========== FIN displayLastUpdates ==========');
        }

        // Charger les donn√©es de ventes
        async function loadVentesData() {
            try {
                const selectedDateParam = getSelectedDate();
                const url = `/api/realtime/reconciliation?date=${selectedDateParam}`;
                
                const response = await fetch(url, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                console.log('üìä R√©sultat API ventes:', result);

                // La structure est {success: true, data: {resume: [...], details: {...}}}
                if (result.success && result.data && result.data.resume) {
                    console.log('üìä Nombre de PDV:', result.data.resume.length);
                    
                    // Extraire les ventes par PDV depuis le r√©sum√©
                    const ventesData = result.data.resume.map(pdv => ({
                        pointVente: pdv.pointVente,
                        totalVentes: pdv.ventesSaisies || 0,
                        nombreVentes: 0
                    }));
                    
                    // Trier par ventes d√©croissantes
                    ventesData.sort((a, b) => b.totalVentes - a.totalVentes);
                    
                    console.log('üìä Ventes format√©es et tri√©es:', ventesData);
                    
                    displayVentesChart(ventesData);
                    document.getElementById('loading-ventes').style.display = 'none';
                    document.getElementById('ventes-content').style.display = 'block';
                    
                    const now = new Date();
                    document.getElementById('derniere-maj-ventes').textContent = 
                        `Derni√®re mise √† jour: ${now.toLocaleTimeString('fr-FR')}`;
                } else {
                    console.error('‚ùå Format de r√©ponse inattendu:', result);
                    document.getElementById('loading-ventes').style.display = 'none';
                }
            } catch (error) {
                console.error('‚ùå Erreur chargement ventes:', error);
                document.getElementById('loading-ventes').style.display = 'none';
            }
        }

        // Variable globale pour stocker les ventes du jour par PDV
        // Charger les statuts de commandes (A=En Attente, P=Pay√©) depuis CommandeInfo
        async function loadPaiementsData() {
            try {
                const selectedDateParam = getSelectedDate();
                const response = await fetch(`/api/realtime/commandes-statut?date=${selectedDateParam}`, {
                    credentials: 'include'
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const result = await response.json();
                console.log('üí≥ R√©sultat commandes-statut:', result);

                if (result.success) {
                    displayPaiementsChart(result.data || {});
                    document.getElementById('loading-paiements').style.display = 'none';
                    document.getElementById('paiements-content').style.display = 'block';
                } else {
                    console.error('‚ùå Format de r√©ponse inattendu:', result);
                    document.getElementById('loading-paiements').style.display = 'none';
                }
            } catch (error) {
                console.error('‚ùå Erreur chargement paiements:', error);
                document.getElementById('loading-paiements').style.display = 'none';
            }
        }

        // Afficher le graphique des commandes par statut (A=En Attente, P=Pay√©)
        function displayPaiementsChart(data) {
            const ctx = document.getElementById('paiementsChart');
            
            if (paiementsChart) {
                paiementsChart.destroy();
            }

            // Filtrer "Chambre froide"
            const labels = Object.keys(data).filter(pdv =>
                !pdv.toLowerCase().includes('chambre froide')
            );

            const dataPayes    = labels.map(pdv => data[pdv]?.P || 0);
            const dataAttente  = labels.map(pdv => data[pdv]?.A || 0);

            paiementsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Pay√© (P)',
                            data: dataPayes,
                            backgroundColor: '#10b981',
                            borderRadius: 8,
                        },
                        {
                            label: 'En Attente (A)',
                            data: dataAttente,
                            backgroundColor: '#f59e0b',
                            borderRadius: 8,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: { top: 60 } },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { font: { size: 12, weight: 'bold' }, padding: 10, boxWidth: 15, boxHeight: 15 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const formatted = new Intl.NumberFormat('fr-FR').format(value);
                                    return `${context.dataset.label}: ${formatted} FCFA`;
                                },
                                afterBody: function(context) {
                                    if (context.length > 0) {
                                        const pdv = context[0].label;
                                        const paye = data[pdv]?.P || 0;
                                        const attente = data[pdv]?.A || 0;
                                        const total = paye + attente;
                                        return [
                                            '',
                                            `Total: ${new Intl.NumberFormat('fr-FR').format(total)} FCFA`,
                                            `Pay√© (P): ${new Intl.NumberFormat('fr-FR').format(paye)} FCFA`,
                                            `En Attente (A): ${new Intl.NumberFormat('fr-FR').format(attente)} FCFA`
                                        ];
                                    }
                                }
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: function(value) {
                                if (value === 0) return '';
                                return new Intl.NumberFormat('fr-FR').format(value);
                            },
                            color: '#1f2937',
                            font: { weight: 'bold', size: 10 }
                        }
                    },
                    scales: {
                        x: { stacked: false },
                        y: {
                            stacked: false,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return new Intl.NumberFormat('fr-FR').format(value);
                                }
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // Calculer et afficher le total
            const totalPayes   = dataPayes.reduce((sum, val) => sum + val, 0);
            const totalAttente = dataAttente.reduce((sum, val) => sum + val, 0);
            const total = totalPayes + totalAttente;

            document.getElementById('total-paiements').innerHTML = `
                ${new Intl.NumberFormat('fr-FR').format(total)} FCFA
                <div style="font-size: 14px; margin-top: 8px; color: #6b7280;">
                    <span style="color: #10b981;">Pay√© (P): ${new Intl.NumberFormat('fr-FR').format(totalPayes)} FCFA</span>
                    &nbsp;|&nbsp;
                    <span style="color: #f59e0b;">En Attente (A): ${new Intl.NumberFormat('fr-FR').format(totalAttente)} FCFA</span>
                </div>
            `;
        }

        // Charger les donn√©es de stock
        async function loadStockData() {
            try {
                const selectedDateParam = getSelectedDate();
                const url = `/api/realtime/reconciliation?date=${selectedDateParam}`;
                
                const response = await fetch(url, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                console.log('üì¶ R√©sultat API stock:', result);
                console.log('üì¶ STRUCTURE COMPL√àTE API STOCK:', JSON.stringify(result, null, 2));
                console.log('üì¶ Details pr√©sents:', result.data && result.data.details ? 'OUI' : 'NON');

                // La structure est {success: true, data: {resume: [...], details: {...}}}
                if (result.success && result.data && result.data.details) {
                    console.log('üì¶ Nombre de PDV dans details:', Object.keys(result.data.details).length);
                    // Mapper les produits de l'API vers nos produits du tableau de bord
                    const produitMapping = {
                        'Boeuf': 'boeuf',
                        'Veau': 'veau',
                        'Agneau': 'agneau',
                        'Poulet': 'poulet',
                        'Yell': 'yell',
                        'Viande Hach√©e': 'viande_hachee',
                        'Viande hach√©e': 'viande_hachee',
                        'Mergez': 'mergez',
                        'Laxass': 'laxass',
                        'Poisson': 'poisson'
                    };
                    
                    const stockData = [];
                    
                    // Pour chaque point de vente
                    Object.keys(result.data.details).forEach(pointVente => {
                        const pdvDetails = result.data.details[pointVente];
                        const stocks = [];
                        
                        // Pour chaque produit que nous voulons afficher
                        Object.keys(produitMapping).forEach(produitAPI => {
                            const produitKey = produitMapping[produitAPI];
                            
                            if (pdvDetails[produitAPI]) {
                                const data = pdvDetails[produitAPI];
                                
                                // Debug pour le poisson
                                if (produitAPI === 'Poisson') {
                                    console.log(`üêü [DEBUG] Poisson data pour ${pointVente}:`, data);
                                    console.log(`üêü [DEBUG] poissonDetails:`, data.poissonDetails);
                                }
                                
                                // Utiliser les champs "Nombre" (kg) et non les montants (FCFA)
                                const stockMatinNombre = parseFloat(data.stockMatinNombre) || 0;
                                const transfertsNombre = parseFloat(data.transfertsNombre) || 0;
                                const ventesNombre = parseFloat(data.ventesNombre) || 0; // Ventes saisies
                                const ventesNombreAjustePack = parseFloat(data.ventesNombreAjustePack) || ventesNombre; // Total avec packs
                                
                                // Calcul du stock actuel : Stock Matin + Transferts - Ventes (avec packs)
                                const stockActuel = stockMatinNombre + transfertsNombre - ventesNombreAjustePack;
                                
                                // Cr√©er les d√©tails de transferts (simplifi√©)
                                const transfertsDetails = [];
                                if (transfertsNombre !== 0) {
                                    if (transfertsNombre > 0) {
                                        transfertsDetails.push({
                                            type: 'entr√©e',
                                            source: 'Autre PDV',
                                            quantite: Math.abs(transfertsNombre)
                                        });
                                    } else {
                                        transfertsDetails.push({
                                            type: 'sortie',
                                            destination: 'Autre PDV',
                                            quantite: Math.abs(transfertsNombre)
                                        });
                                    }
                                }
                                
                                stocks.push({
                                    produit: produitKey,
                                    stockActuel: Math.round(stockActuel * 100) / 100,
                                    details: {
                                        stockMatin: stockMatinNombre,
                                        transferts: transfertsNombre,
                                        transfertsDetails: transfertsDetails,
                                        ventes: ventesNombre, // Ventes saisies uniquement
                                        ventesTotales: ventesNombreAjustePack, // Total avec packs
                                        derniereMAJ: new Date().toISOString(),
                                        poissonDetails: data.poissonDetails || undefined // D√©tails par type de poisson
                                    }
                                });
                            }
                        });
                        
                        stockData.push({
                            pointVente: pointVente,
                            stocks: stocks
                        });
                    });
                    
                    console.log('üì¶ Stock format√©:', stockData);
                    
                    displayStockTable(stockData);
                    const loadingStock = document.getElementById('loading-stock');
                    const stockContent = document.getElementById('stock-content');
                    if (loadingStock) loadingStock.style.display = 'none';
                    if (stockContent) stockContent.style.display = 'block';
                    
                    const derniereMAJ = document.getElementById('derniere-maj-stock');
                    if (derniereMAJ) {
                        const now = new Date();
                        derniereMAJ.textContent = `Derni√®re mise √† jour: ${now.toLocaleTimeString('fr-FR')}`;
                    }
                } else {
                    console.error('‚ùå Format de r√©ponse inattendu:', result);
                    const loadingStock = document.getElementById('loading-stock');
                    if (loadingStock) loadingStock.style.display = 'none';
                }
            } catch (error) {
                console.error('‚ùå Erreur chargement stock:', error);
                const loadingStock = document.getElementById('loading-stock');
                if (loadingStock) loadingStock.style.display = 'none';
            }
        }

        // Afficher le graphique des ventes
        function displayVentesChart(data) {
            const ctx = document.getElementById('ventesChart');
            
            if (ventesChart) {
                ventesChart.destroy();
            }

            // Filtrer "Chambre froide"
            const filteredData = data.filter(d => 
                d.pointVente !== 'Chambre froide' && 
                d.pointVente !== 'chambre froide' && 
                d.pointVente !== 'Chambre Froide' &&
                d.pointVente !== 'CHAMBRE FROIDE'
            );

            const labels = filteredData.map(d => d.pointVente);
            const values = filteredData.map(d => d.totalVentes);
            const colors = [
                '#dc3545', '#0d6efd', '#198754', '#ffc107', 
                '#6f42c1', '#fd7e14', '#20c997', '#d63384',
                '#6610f2', '#e83e8c', '#17a2b8', '#28a745'
            ];
            
            // Hauteur dynamique bas√©e sur le nombre de PDV (minimum 300px, ~60px par PDV)
            const dynamicHeight = Math.max(300, filteredData.length * 60);
            const chartContainer = ctx.parentElement;
            chartContainer.style.height = `${dynamicHeight}px`;

            ventesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ventes (FCFA)',
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderRadius: 8,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const formatted = new Intl.NumberFormat('fr-FR').format(value);
                                    return `${formatted} FCFA`;
                                }
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: function(value) {
                                return new Intl.NumberFormat('fr-FR').format(value) + ' FCFA';
                            },
                            color: '#1f2937',
                            font: {
                                weight: 'bold',
                                size: 12
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return new Intl.NumberFormat('fr-FR', {
                                        notation: 'compact',
                                        compactDisplay: 'short'
                                    }).format(value);
                                }
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });

            // Calculer et afficher le total
            const total = values.reduce((sum, val) => sum + val, 0);
            const formattedTotal = new Intl.NumberFormat('fr-FR').format(total);
            document.getElementById('total-ventes').textContent = `${formattedTotal} FCFA`;
        }

        // Afficher le tableau de stock
        function displayStockTable(data) {
            const tbody = document.getElementById('stock-tbody');
            if (!tbody) return;
            tbody.innerHTML = '';

            const produits = ['boeuf', 'veau', 'agneau', 'poulet', 'yell', 'viande_hachee', 'mergez', 'laxass', 'poisson'];

            data.forEach(pdv => {
                const row = document.createElement('tr');
                row.className = 'pdv-row';

                // Colonne PDV
                const tdPdv = document.createElement('td');
                tdPdv.style.textAlign = 'left';
                tdPdv.style.fontWeight = '600';
                tdPdv.textContent = pdv.pointVente;
                row.appendChild(tdPdv);

                // Colonnes produits
                produits.forEach(produit => {
                    const stock = pdv.stocks.find(s => s.produit === produit);
                    const td = document.createElement('td');
                    
                    if (stock) {
                        const span = document.createElement('span');
                        span.className = 'stock-value';
                        span.textContent = formaterQuantite(stock.stockActuel, produit);
                        
                        // Couleur selon le niveau
                        if (stock.stockActuel > 30) {
                            span.classList.add('stock-high');
                        } else if (stock.stockActuel >= 10) {
                            span.classList.add('stock-medium');
                        } else {
                            span.classList.add('stock-low');
                        }

                        // Ajouter les √©v√©nements pour le tooltip
                        span.dataset.pdv = pdv.pointVente;
                        span.dataset.produit = produit;
                        span.dataset.details = JSON.stringify(stock.details);
                        
                        span.addEventListener('mouseenter', showTooltip);
                        span.addEventListener('mouseleave', hideTooltip);
                        
                        td.appendChild(span);
                    } else {
                        td.textContent = '-';
                    }
                    
                    row.appendChild(td);
                });

                tbody.appendChild(row);
            });
        }

        // Afficher le tooltip
        function showTooltip(event) {
            const element = event.target;
            const pdv = element.dataset.pdv;
            const produit = element.dataset.produit;
            
            let details;
            try {
                details = JSON.parse(element.dataset.details);
            } catch (e) {
                console.error('Erreur parsing tooltip details:', e);
                return;
            }

            const tooltip = document.getElementById('custom-tooltip');
            
            const produitNames = {
                'boeuf': 'Boeuf',
                'veau': 'Veau',
                'agneau': 'Agneau',
                'poulet': 'Poulet',
                'yell': 'Yell',
                'viande_hachee': 'Viande Hach√©e',
                'mergez': 'Mergez',
                'laxass': 'Laxass',
                'poisson': 'Poisson'
            };

            // D√©terminer l'unit√© en fonction du produit
            const unite = produit === 'poulet' ? 'pcs' : 'kg';
            const formatValue = (val) => {
                if (produit === 'poulet') {
                    return `${Math.round(val)} ${unite}`;
                }
                return `${val.toFixed(1)} ${unite}`;
            };

            let transfertsHTML = '';
            if (details.transfertsDetails && details.transfertsDetails.length > 0) {
                details.transfertsDetails.forEach(t => {
                    const sign = t.type === 'entr√©e' ? '+' : '-';
                    const source = t.type === 'entr√©e' ? `de ${t.source}` : `vers ${t.destination}`;
                    transfertsHTML += `
                        <div class="transfer-detail">
                            ‚Ä¢ ${sign}${formatValue(t.quantite)} ${source}
                        </div>
                    `;
                });
            }

            // Calculer le stock actuel avec le total des sorties (ventes + packs)
            const ventesTotalesForCalc = (details.ventesTotales !== undefined) ? details.ventesTotales : details.ventes;
            const stockActuel = details.stockMatin + details.transferts - ventesTotalesForCalc;

            // R√©cup√©rer les ventes de packs pour ce PDV et produit
            const produitKey = produit.toLowerCase().replace(/ /g, '_');
            
            console.log(`üîç [TOOLTIP] Recherche pour PDV: "${pdv}", Produit: "${produit}", ProduitKey: "${produitKey}"`);
            console.log(`üîç [TOOLTIP] packSalesData complet:`, packSalesData);
            console.log(`üîç [TOOLTIP] packSalesData['${pdv}']:`, packSalesData[pdv]);
            
            let ventesPacks = 0;
            if (packSalesData[pdv] && packSalesData[pdv][produitKey] !== undefined) {
                ventesPacks = packSalesData[pdv][produitKey];
                console.log(`‚úÖ [TOOLTIP] Ventes packs trouv√©es: ${ventesPacks} kg`);
            } else {
                console.log(`‚ùå [TOOLTIP] Aucune vente de pack trouv√©e pour ${produitKey}`);
            }

            console.log(`üîç [TOOLTIP] ${produit} - ${pdv}:`, {
                ventesSaisies: details.ventes,
                ventesPacks: ventesPacks,
                ventesTotales: details.ventesTotales || details.ventes,
                note: 'ventesTotales inclut les packs'
            });

            // HTML pour afficher les ventes saisies et l'impact des packs
            let ventesDecompositionHTML = '';
            if (details.ventes > 0 || ventesPacks > 0) {
                ventesDecompositionHTML = `
                    <div class="tooltip-row" style="padding-left: 20px; font-size: 12px;">
                        <span class="tooltip-label">‚Ä¢ Ventes saisies:</span>
                        <span class="tooltip-value">-${formatValue(details.ventes)}</span>
                    </div>
                    <div class="tooltip-row" style="padding-left: 20px; font-size: 12px; border-left: 3px solid #f59e0b; margin-left: 10px;">
                        <span class="tooltip-label">üì¶ Impact packs:</span>
                        <span class="tooltip-value">-${formatValue(ventesPacks)}</span>
                    </div>
                `;
            }

            const ventesTotalesDisplay = (details.ventesTotales !== undefined) ? details.ventesTotales : (details.ventes + ventesPacks);

            // Si c'est du poisson, afficher la d√©composition par type
            let poissonDetailsHTML = '';
            if (produit === 'poisson' && details.poissonDetails && Object.keys(details.poissonDetails).length > 0) {
                poissonDetailsHTML = `
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 2px solid #4682B4;">
                        <div class="tooltip-row" style="font-weight: bold; color: #4682B4; margin-bottom: 8px;">
                            <span>üêü D√©tail par type de poisson:</span>
                        </div>
                `;
                
                // Liste des produits de poisson dans l'ordre
                const produitsPoissonOrder = ['Dorade', 'Seud (barracuda)', 'Beurre', 'Crevettes', 'Thiof', 'Sompote'];
                
                produitsPoissonOrder.forEach(poissonType => {
                    const poissonData = details.poissonDetails[poissonType];
                    if (poissonData && (poissonData.ventesNombre > 0 || poissonData.stockMatinNombre > 0 || poissonData.stockSoirNombre > 0 || poissonData.transfertsNombre !== 0)) {
                        // Utiliser les champs *Nombre pour les quantit√©s en kg
                        const poissonStockMatin = poissonData.stockMatinNombre || 0;
                        const poissonTransferts = poissonData.transfertsNombre || 0;
                        const poissonVentes = poissonData.ventesNombre || 0;
                        const poissonStockActuel = poissonStockMatin + poissonTransferts - poissonVentes;
                        
                        poissonDetailsHTML += `
                            <div style="padding-left: 15px; margin-bottom: 8px; border-left: 3px solid #4682B4;">
                                <div class="tooltip-row" style="font-weight: 600; color: #1e40af; margin-bottom: 4px;">
                                    <span>${poissonType}:</span>
                                </div>
                                <div class="tooltip-row" style="padding-left: 10px; font-size: 11px;">
                                    <span class="tooltip-label">üåÖ Stock matin:</span>
                                    <span class="tooltip-value">${formatValue(poissonStockMatin)}</span>
                                </div>
                                <div class="tooltip-row" style="padding-left: 10px; font-size: 11px;">
                                    <span class="tooltip-label">üîÑ Transferts:</span>
                                    <span class="tooltip-value" style="color: ${poissonTransferts > 0 ? '#059669' : poissonTransferts < 0 ? '#dc2626' : 'inherit'};">${poissonTransferts > 0 ? '+' : ''}${formatValue(poissonTransferts)}</span>
                                </div>
                                <div class="tooltip-row" style="padding-left: 10px; font-size: 11px;">
                                    <span class="tooltip-label">üõí Ventes:</span>
                                    <span class="tooltip-value">-${formatValue(poissonVentes)}</span>
                                </div>
                                <div class="tooltip-row" style="padding-left: 10px; font-size: 11px; font-weight: 600;">
                                    <span class="tooltip-label">‚úÖ Stock actuel:</span>
                                    <span class="tooltip-value">${formatValue(poissonStockActuel)}</span>
                                </div>
                            </div>
                        `;
                    }
                });
                
                poissonDetailsHTML += `</div>`;
            }

            tooltip.innerHTML = `
                <div class="tooltip-header">
                    üì¶ ${produitNames[produit]} - ${escapeHtml(pdv)}
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">üåÖ Stock matin:</span>
                    <span class="tooltip-value">${formatValue(details.stockMatin)}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">üîÑ Transferts:</span>
                    <span class="tooltip-value">${details.transferts > 0 ? '+' : ''}${formatValue(Math.abs(details.transferts))}</span>
                </div>
                ${transfertsHTML}
                <div class="tooltip-row">
                    <span class="tooltip-label">üõí Total sorties:</span>
                    <span class="tooltip-value">-${formatValue(ventesTotalesDisplay)}</span>
                </div>
                ${ventesDecompositionHTML}
                <div class="tooltip-row">
                    <span class="tooltip-label">‚úÖ Stock actuel:</span>
                    <span class="tooltip-value">${formatValue(stockActuel)}</span>
                </div>
                ${poissonDetailsHTML}
                <div style="text-align: center; margin-top: 10px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                    <small class="text-muted">‚è∞ ${(() => {
                        const d = new Date(details.derniereMAJ);
                        const hours = String(d.getUTCHours()).padStart(2, '0');
                        const minutes = String(d.getUTCMinutes()).padStart(2, '0');
                        const seconds = String(d.getUTCSeconds()).padStart(2, '0');
                        return `${hours}:${minutes}:${seconds}`;
                    })()}</small>
                </div>
            `;

            // Positionner le tooltip
            const rect = element.getBoundingClientRect();
            tooltip.style.left = `${rect.left + window.scrollX}px`;
            tooltip.style.top = `${rect.bottom + window.scrollY + 10}px`;
            tooltip.classList.add('show');
        }

        // Cacher le tooltip
        function hideTooltip() {
            const tooltip = document.getElementById('custom-tooltip');
            tooltip.classList.remove('show');
        }

        let packSalesData = {}; // Variable globale pour les ventes de packs (pour tooltip)

        // Fonction pour formater les quantit√©s avec l'unit√© appropri√©e
        function formaterQuantite(quantite, produit) {
            if (produit === 'poulet') {
                return `${Math.round(quantite)} pcs`;
            }
            return `${quantite.toFixed(1)} kg`;
        }

        // STUB supprim√© - displayWebOrders supprim√© (section weborders retir√©e)
        function displayWebOrders_REMOVED(ordersData) {
            const tbody = document.getElementById('weborders-tbody');
            if (!tbody) return;
            tbody.innerHTML = '';

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center text-muted">Aucune commande web pour cette date</td></tr>';
                document.getElementById('total-weborders').textContent = '0 FCFA';
                document.getElementById('count-weborders').textContent = '0';
                return;
            }

            let totalAmount = 0;

            orders.forEach(order => {
                const row = document.createElement('tr');
                
                // Le montant est dans totalAmount
                const amount = parseFloat(order.totalAmount) || 0;
                totalAmount += amount;

                const orderTime = new Date(order.orderDate);
                // Utiliser UTC pour l'heure
                const hours = String(orderTime.getUTCHours()).padStart(2, '0');
                const minutes = String(orderTime.getUTCMinutes()).padStart(2, '0');
                const timeStr = `${hours}:${minutes}`;
                
                // Formater la date en UTC
                const day = String(orderTime.getUTCDate()).padStart(2, '0');
                const month = String(orderTime.getUTCMonth() + 1).padStart(2, '0');
                const year = orderTime.getUTCFullYear();
                const dateStr = `${day}/${month}/${year}`;

                // Les infos sont dans jsonContent avec la structure exacte fournie
                let customerName = 'N/A';
                let customerPhone = 'N/A';
                let address = 'N/A';
                let productsHTML = '';
                let montantsHTML = '';
                let note = '';
                let texteContent = order.notes || '';
                
                try {
                    if (order.jsonContent) {
                        const jsonData = typeof order.jsonContent === 'string' 
                            ? JSON.parse(order.jsonContent) 
                            : order.jsonContent;
                        
                        if (!texteContent && jsonData.text) texteContent = jsonData.text;
                        
                        // Infos client - structure exacte
                        customerName = jsonData.customerName || 'N/A';
                        customerPhone = jsonData.phone || 'N/A';
                        
                        // Adresse - billingAddress.lines[0]
                        if (jsonData.billingAddress && jsonData.billingAddress.lines && jsonData.billingAddress.lines.length > 0) {
                            address = jsonData.billingAddress.lines[0];
                        }
                        
                        // Note/remarque
                        note = jsonData.note || '';
                        
                        // Produits command√©s - structure items avec produit, quantite et prix
                        const items = jsonData.items || [];
                        if (items && items.length > 0) {
                            // Colonne Produits (nom + quantit√©)
                            productsHTML = items.map(item => {
                                const productName = escapeHtml(item.produit || 'Produit');
                                const quantity = Number(item.quantite) || 0;
                                return `<div style="margin-bottom: 4px;"><strong>${productName}</strong>: ${quantity} kg</div>`;
                            }).join('');
                            
                            // Colonne Montant (prix par produit)
                            montantsHTML = items.map(item => {
                                const price = Number(item.prix?.amount) || 0;
                                const formattedPrice = new Intl.NumberFormat('fr-FR').format(price);
                                return `<div style="margin-bottom: 4px; text-align: right;">${formattedPrice} FCFA</div>`;
                            }).join('');
                        } else {
                            productsHTML = '<em class="text-muted">Aucun produit</em>';
                            montantsHTML = '-';
                        }
                    }
                } catch (e) {
                    console.error('Erreur parsing jsonContent:', e, order.jsonContent);
                    productsHTML = '<em class="text-danger">Erreur lecture</em>';
                    montantsHTML = '-';
                }

                // Texte complet (notes ou jsonContent.text)
                const hasTexte = texteContent && texteContent.trim().length > 0;
                if (hasTexte) window._webOrdersTexteMap[order.id] = texteContent;
                const texteCell = hasTexte
                    ? `<button type="button" class="btn btn-sm btn-outline-secondary" onclick="afficherTexteWebOrderRealtime(${order.id})" title="Voir le texte complet"><i class="bi bi-file-text"></i> Voir</button>`
                    : '<span class="text-muted">‚Äî</span>';

                // Construire les donn√©es de la ligne pour la copie
                const rowDataForCopy = {
                    commandId: order.commandId || 'N/A',
                    customerName,
                    customerPhone,
                    address,
                    products: productsHTML.replace(/<[^>]*>/g, '').trim(), // Supprimer les balises HTML
                    amounts: montantsHTML.replace(/<[^>]*>/g, '').trim(),
                    total: amount,
                    time: timeStr,
                    note: note || '-'
                };
                
                // Fonction pour encoder les attributs HTML (escape tous les caract√®res dangereux)
                function encodeForAttribute(str) {
                    return String(str)
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;');
                }

                row.innerHTML = `
                    <td style="white-space: nowrap;">${dateStr}</td>
                    <td><strong>${escapeHtml(order.commandId || 'N/A')}</strong></td>
                    <td>${escapeHtml(customerName)}</td>
                    <td>${escapeHtml(customerPhone)}</td>
                    <td style="max-width: 200px; font-size: 12px;">${escapeHtml(address)}</td>
                    <td style="min-width: 150px;">${productsHTML}</td>
                    <td class="text-center">${texteCell}</td>
                    <td style="min-width: 100px;">${montantsHTML}</td>
                    <td class="text-end"><strong style="color: #198754; font-size: 14px;">${new Intl.NumberFormat('fr-FR').format(amount)} FCFA</strong></td>
                    <td class="text-center">${timeStr}</td>
                    <td style="max-width: 150px; font-size: 12px;">${note ? `<em>"${escapeHtml(note)}"</em>` : '-'}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-secondary copy-row-btn" 
                                data-row="${encodeForAttribute(JSON.stringify(rowDataForCopy))}" 
                                title="Copier cette ligne">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </td>
                `;
                
                // Ajouter l'√©v√©nement de copie sur le bouton
                const copyBtn = row.querySelector('.copy-row-btn');
                copyBtn.addEventListener('click', function(e) {
                    copyOrderRow(e, this);
                });
                
                tbody.appendChild(row);
            });

            // Afficher le total
            const formattedTotal = new Intl.NumberFormat('fr-FR').format(totalAmount);
            document.getElementById('total-weborders').textContent = `${formattedTotal} FCFA`;
            document.getElementById('count-weborders').textContent = orders.length;
        }

        // Charger les donn√©es de ventes de packs
        async function loadPackSalesCompositionData() {
            console.log('üì¶ [PACKS] ========== D√âBUT loadPackSalesCompositionData ==========');
            try {
                const selectedDateParam = getSelectedDate();
                const url = `/api/realtime/packs?date=${selectedDateParam}`;
                
                console.log('üì¶ [PACKS] URL appel√©e:', url);
                
                const response = await fetch(url, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                console.log('üì¶ [PACKS] R√©sultat API:', result);
                console.log('üì¶ [PACKS] Structure compl√®te:', JSON.stringify(result, null, 2));

                if (result.success && result.pointsVente) {
                    displayPackSalesData(result.pointsVente);
                    document.getElementById('loading-packs').style.display = 'none';
                    document.getElementById('packs-content').style.display = 'block';
                } else {
                    console.error('‚ùå [PACKS] Format de r√©ponse inattendu:', result);
                    console.error('‚ùå [PACKS] result.success:', result.success);
                    console.error('‚ùå [PACKS] result.pointsVente:', result.pointsVente);
                    document.getElementById('loading-packs').style.display = 'none';
                }
            } catch (error) {
                console.error('‚ùå [PACKS] Erreur chargement pack sales:', error);
                document.getElementById('loading-packs').style.display = 'none';
            }
        }

        // Afficher les donn√©es de ventes de packs
        function displayPackSalesData(pointsVenteData) {
            console.log('üì¶ [PACKS] displayPackSalesData appel√©e avec:', pointsVenteData);
            const tbody = document.getElementById('packs-tbody');
            tbody.innerHTML = '';

            // R√©initialiser les donn√©es globales de packs
            packSalesData = {};

            if (!pointsVenteData || Object.keys(pointsVenteData).length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Aucune vente de pack pour cette date</td></tr>';
                return;
            }

            // Mapper les noms de produits de l'API vers les noms utilis√©s
            const productMapping = {
                'boeuf en d√©tail': 'boeuf',
                'boeuf en gros': 'boeuf',
                'boeuf': 'boeuf',
                'veau en d√©tail': 'veau',
                'veau en gros': 'veau',
                'veau': 'veau',
                'agneau': 'agneau',
                'poulet en d√©tail': 'poulet',
                'poulet en gros': 'poulet',
                'poulet': 'poulet',
                'yell': 'yell',
                'viande hach√©e': 'viande_hachee',
                'viande hachee': 'viande_hachee',
                'laxass': 'laxass',
                'poisson': 'poisson',
                'oeuf': 'oeuf'
            };

            // Traiter chaque point de vente
            Object.keys(pointsVenteData).forEach(pdv => {
                const pdvInfo = pointsVenteData[pdv];
                
                if (!packSalesData[pdv]) {
                    packSalesData[pdv] = {
                        boeuf: 0,
                        veau: 0,
                        agneau: 0,
                        poulet: 0,
                        yell: 0,
                        viande_hachee: 0,
                        laxass: 0,
                        poisson: 0,
                        oeuf: 0
                    };
                }

                // Liste des packs vendus
                let packsInfo = '';
                if (pdvInfo.packsVendus) {
                    packsInfo = Object.entries(pdvInfo.packsVendus)
                        .map(([packName, packInfo]) => `${escapeHtml(packName)} (√ó${packInfo.quantite})`)
                        .join('<br>');
                }

                // Traiter la composition agr√©g√©e
                if (pdvInfo.compositionAgregee) {
                    Object.entries(pdvInfo.compositionAgregee).forEach(([produitAPI, info]) => {
                        const produitKey = productMapping[produitAPI.toLowerCase()] || produitAPI.toLowerCase().replace(/ /g, '_');
                        const quantite = parseFloat(info.quantite) || 0;
                        
                        if (packSalesData[pdv][produitKey] !== undefined) {
                            packSalesData[pdv][produitKey] += quantite;
                        }
                    });
                }

                // Cr√©er la ligne du tableau
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 600;">${escapeHtml(pdv)}</td>
                    <td class="text-center" style="font-size: 12px;">${packsInfo}</td>
                    <td class="text-center">${packSalesData[pdv].boeuf > 0 ? packSalesData[pdv].boeuf.toFixed(1) + ' kg' : '-'}</td>
                    <td class="text-center">${packSalesData[pdv].veau > 0 ? packSalesData[pdv].veau.toFixed(1) + ' kg' : '-'}</td>
                    <td class="text-center">${packSalesData[pdv].agneau > 0 ? packSalesData[pdv].agneau.toFixed(1) + ' kg' : '-'}</td>
                    <td class="text-center">${packSalesData[pdv].poulet > 0 ? Math.round(packSalesData[pdv].poulet) + ' pcs' : '-'}</td>
                    <td class="text-end" style="font-weight: 600;">${new Intl.NumberFormat('fr-FR').format(pdvInfo.montantTotal || 0)} FCFA</td>
                `;
                tbody.appendChild(row);
            });

            // Stocker dans la variable globale pour le tooltip
            console.log('üì¶ [PACKS] Donn√©es stock√©es pour tooltip:', packSalesData);
        }

        // Copier une ligne de commande
        function copyOrderRow(event, button) {
            try {
                const rowData = JSON.parse(button.getAttribute('data-row'));
                
                // Extraire les produits depuis le HTML
                const row = button.closest('tr');
                const jsonData = orders.find(o => o.commandId === rowData.commandId);
                
                if (!jsonData || !jsonData.jsonContent) {
                    throw new Error('Donn√©es de commande non trouv√©es');
                }
                
                const orderData = typeof jsonData.jsonContent === 'string' 
                    ? JSON.parse(jsonData.jsonContent) 
                    : jsonData.jsonContent;
                
                // Cr√©er le format de l'email (UTC)
                const orderDate = new Date(jsonData.orderDate);
                const monthNames = ['janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin', 
                                   'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'];
                const formattedDate = `${orderDate.getUTCDate()} ${monthNames[orderDate.getUTCMonth()]} ${orderDate.getUTCFullYear()}`;
                
                let textToCopy = `[Commande n¬∞${orderData.orderNumber}] (${formattedDate})\n\n`;
                
                // Tableau des produits (sans les carr√©s)
                textToCopy += `Produit\t\tQuantit√©\tPrix\n`;
                
                if (orderData.items && orderData.items.length > 0) {
                    orderData.items.forEach(item => {
                        const price = new Intl.NumberFormat('fr-FR').format(item.prix?.amount || 0);
                        textToCopy += `${item.produit}\t\t${item.quantite}\t\t${price} CFA\n`;
                    });
                }
                
                textToCopy += `\n`;
                textToCopy += `Sous-total :\t\t\t${new Intl.NumberFormat('fr-FR').format(orderData.total?.amount ?? 0)} CFA\n`;
                textToCopy += `Exp√©dition :\t\t\tFree shipping\n`;
                textToCopy += `Moyen de paiement :\t\tPaiement √† la livraison\n`;
                textToCopy += `Total :\t\t\t\t${new Intl.NumberFormat('fr-FR').format(orderData.total?.amount ?? 0)} CFA\n`;
                
                // Adresse de livraison uniquement (pas de facturation)
                if (orderData.shippingAddress || orderData.billingAddress) {
                    const shippingAddr = orderData.shippingAddress || orderData.billingAddress;
                    textToCopy += `\n\nAdresse de livraison\n`;
                    textToCopy += `${shippingAddr?.name ?? 'N/A'}\n`;
                    if (shippingAddr.lines) {
                        textToCopy += `${shippingAddr.lines.join('\n')}\n`;
                    }
                    textToCopy += `${shippingAddr?.phone ?? 'N/A'}\n`;
                }

                // Copier dans le presse-papier
                navigator.clipboard.writeText(textToCopy).then(() => {
                    const originalHTML = button.innerHTML;
                    button.innerHTML = '<i class="bi bi-check-lg"></i>';
                    button.classList.remove('btn-outline-secondary');
                    button.classList.add('btn-success');
                    
                    setTimeout(() => {
                        button.innerHTML = originalHTML;
                        button.classList.remove('btn-success');
                        button.classList.add('btn-outline-secondary');
                    }, 1500);
                }).catch(err => {
                    console.error('Erreur copie ligne:', err);
                    alert('Erreur lors de la copie');
                });
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la copie de la ligne');
            }
        }

        // Copier le tableau des commandes web
        function copyWebOrdersTable(event) {
            try {
                if (orders.length === 0) {
                    alert('Aucune commande √† copier');
                    return;
                }

                let allText = '';

                // Copier chaque commande dans le format structur√©
                orders.forEach((jsonData, index) => {
                    const orderData = typeof jsonData.jsonContent === 'string' 
                        ? JSON.parse(jsonData.jsonContent) 
                        : jsonData.jsonContent;
                    
                    // Cr√©er le format de l'email (UTC)
                    const orderDate = new Date(jsonData.orderDate);
                    const monthNames = ['janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin', 
                                       'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'];
                    const formattedDate = `${orderDate.getUTCDate()} ${monthNames[orderDate.getUTCMonth()]} ${orderDate.getUTCFullYear()}`;
                    
                    let textToCopy = `[Commande n¬∞${orderData.orderNumber}] (${formattedDate})\n\n`;
                    
                    // Tableau des produits
                    textToCopy += `Produit\t\tQuantit√©\tPrix\n`;
                    
                    if (orderData.items && orderData.items.length > 0) {
                        orderData.items.forEach(item => {
                            const price = new Intl.NumberFormat('fr-FR').format(item.prix?.amount || 0);
                            textToCopy += `${item.produit}\t\t${item.quantite}\t\t${price} CFA\n`;
                        });
                    }
                    
                    textToCopy += `\n`;
                    textToCopy += `Sous-total :\t\t\t${new Intl.NumberFormat('fr-FR').format(orderData.total?.amount ?? 0)} CFA\n`;
                    textToCopy += `Exp√©dition :\t\t\tFree shipping\n`;
                    textToCopy += `Moyen de paiement :\t\tPaiement √† la livraison\n`;
                    textToCopy += `Total :\t\t\t\t${new Intl.NumberFormat('fr-FR').format(orderData.total?.amount ?? 0)} CFA\n`;
                    
                    // Adresse de livraison uniquement
                    if (orderData.shippingAddress || orderData.billingAddress) {
                        const shippingAddr = orderData.shippingAddress || orderData.billingAddress;
                        textToCopy += `\n\nAdresse de livraison\n`;
                        textToCopy += `${shippingAddr?.name ?? 'N/A'}\n`;
                        if (shippingAddr?.lines) {
                            textToCopy += `${shippingAddr.lines.join('\n')}\n`;
                        }
                        textToCopy += `${shippingAddr?.phone ?? 'N/A'}\n`;
                    }

                    allText += textToCopy;
                    
                    // Ajouter un s√©parateur entre les commandes (sauf pour la derni√®re)
                    if (index < orders.length - 1) {
                        allText += '\n\n' + '='.repeat(60) + '\n\n';
                    }
                });

                // Copier dans le presse-papier
                navigator.clipboard.writeText(allText).then(() => {
                    const btn = event.target.closest('button');
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = '<i class="bi bi-check-lg"></i> Copi√© !';
                    btn.classList.remove('btn-outline-primary');
                    btn.classList.add('btn-success');
                    
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-outline-primary');
                    }, 2000);
                }).catch(err => {
                    console.error('Erreur copie:', err);
                    alert('Erreur lors de la copie');
                });
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la copie du tableau');
            }
        }

        // Toggle section g√©n√©rique (pour toutes les sections collapsables)
        function toggleSection(sectionName) {
            const content = document.getElementById(`${sectionName}-collapsible`);
            const toggle = document.getElementById(`${sectionName}-toggle`);
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
                toggle.textContent = '‚ñº';
            } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
                toggle.textContent = '‚ñ≤';
            }
        }

        // Actualiser manuellement
        function refreshData() {
            console.log('üîÑ Actualisation manuelle');
            loadData();
            secondsRemaining = 900; // R√©initialiser √† 15 minutes
        }

        // D√©marrer l'actualisation automatique
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(() => {
                console.log('üîÑ Actualisation automatique');
                loadData();
                secondsRemaining = 900; // 15 minutes
            }, 900000); // 15 minutes = 900 000 ms
        }

        // D√©marrer le compte √† rebours
        function startCountdown() {
            countdownInterval = setInterval(() => {
                secondsRemaining--;
                if (secondsRemaining < 0) {
                    secondsRemaining = 900; // 15 minutes
                }
                updateCountdownDisplay();
            }, 1000);
        }

        // Mettre √† jour l'affichage du compte √† rebours
        function updateCountdownDisplay() {
            const minutes = Math.floor(secondsRemaining / 60);
            const seconds = secondsRemaining % 60;
            const display = `${minutes}m ${seconds.toString().padStart(2, '0')}s`;
            document.getElementById('countdown-timer').textContent = display;
        }

        // Global variable to store AI data for audio
        let currentAIData = null;
        let currentUtterance = null;
        let isReading = false;

        // üîç Check if AI analysis exists in cache for current date
        function checkAICacheStatus() {
            const date = getSelectedDate();
            const threshold = parseFloat(document.getElementById('ai-threshold-input')?.value) || 50000;
            const topN = parseInt(document.getElementById('ai-top-clients-input')?.value) || 10;
            const model = document.getElementById('ai-model-select')?.value || 'default';
            const cacheKey = `ai_analysis_${date}_${threshold}_${topN}_${model}`;
            
            const cacheInfo = document.getElementById('ai-cache-info');
            const btnForce = document.getElementById('btn-ai-force');
            const btnText = document.getElementById('btn-ai-text');
            const resultsDiv = document.getElementById('ai-results');
            
            try {
                const cachedData = sessionStorage.getItem(cacheKey);
                if (cachedData) {
                    // Analysis exists in cache
                    cacheInfo.style.display = 'block';
                    btnForce.style.display = 'inline-block';
                    if (btnText) btnText.textContent = 'Afficher l\'Analyse';
                    
                    // Auto-load if results are hidden
                    if (resultsDiv.style.display === 'none') {
                        console.log('üì¶ Analyse disponible en cache');
                    }
                } else {
                    // No cached analysis
                    cacheInfo.style.display = 'none';
                    btnForce.style.display = 'none';
                    if (btnText) btnText.textContent = 'Lancer l\'Analyse IA';
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Erreur v√©rification cache:', error);
            }
        }

        // ü§ñ AI Interpretation Function
        async function runAIInterpretation(forceRefresh = false) {
            const btn = document.getElementById('btn-ai-analyze');
            const btnForce = document.getElementById('btn-ai-force');
            const loadingDiv = document.getElementById('ai-loading');
            const resultsDiv = document.getElementById('ai-results');
            const cacheInfo = document.getElementById('ai-cache-info');
            
            // Stop any ongoing speech
            if (isReading) {
                stopAudioReading();
            }
            
            // Get selected date
            const date = getSelectedDate();
            
            // Get threshold
            let threshold = parseFloat(document.getElementById('ai-threshold-input').value) || 50000;
            
            // Get topN value
            let topN = parseInt(document.getElementById('ai-top-clients-input').value) || 10;
            
            // Get selected model
            const model = document.getElementById('ai-model-select')?.value || 'default';
            
            // Create cache key (include topN and model for separate caching)
            const cacheKey = `ai_analysis_${date}_${threshold}_${topN}_${model}`;
            
            // Check if we have cached data (unless force refresh)
            if (!forceRefresh) {
                try {
                    const cachedData = sessionStorage.getItem(cacheKey);
                    if (cachedData) {
                        console.log('üì¶ Chargement de l\'analyse depuis le cache');
                        const data = JSON.parse(cachedData);
                        
                        // Store data for audio
                        currentAIData = data;
                        
                        // Extract global order times
                        if (data.salesSummary && data.salesSummary.byPointVente) {
                            let earliestTime = null;
                            let latestTime = null;
                            
                            Object.values(data.salesSummary.byPointVente).forEach(pdvData => {
                                if (pdvData.firstOrderTime && (!earliestTime || pdvData.firstOrderTime < earliestTime)) {
                                    earliestTime = pdvData.firstOrderTime;
                                }
                                if (pdvData.lastOrderTime && (!latestTime || pdvData.lastOrderTime > latestTime)) {
                                    latestTime = pdvData.lastOrderTime;
                                }
                            });
                            
                            currentAIData.firstOrderTime = earliestTime;
                            currentAIData.lastOrderTime = latestTime;
                        }
                        
                        // Display results
                        displayAIResults(data);
                        if (resultsDiv) resultsDiv.style.display = 'block';
                        
                        // Show cache info and force refresh button
                        if (cacheInfo) cacheInfo.style.display = 'block';
                        if (btnForce) btnForce.style.display = 'inline-block';
                        const btnAiTextCached = document.getElementById('btn-ai-text');
                        if (btnAiTextCached) btnAiTextCached.textContent = 'Afficher l\'Analyse';
                        
                        return;
                    }
                } catch (cacheError) {
                    console.warn('‚ö†Ô∏è Erreur lecture cache:', cacheError);
                    // Continue with API call
                }
            }
            
            try {
                // Disable button and show loading
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Analyse en cours...';
                }
                if (loadingDiv) loadingDiv.style.display = 'block';
                if (resultsDiv) resultsDiv.style.display = 'none';
                
                console.log('ü§ñ Lancement analyse IA pour date:', date);
                
                // Step 1: Get list of active points de vente from already loaded sales data
                console.log('üìä √âtape 1: R√©cup√©ration des points de vente actifs...');
                if (btn) btn.innerHTML = '<i class="bi bi-hourglass-split"></i> R√©cup√©ration des PDV...';
                const aiLoadingText = document.getElementById('ai-loading-text');
                const aiLoadingDetails = document.getElementById('ai-loading-details');
                if (aiLoadingText) aiLoadingText.textContent = 'R√©cup√©ration des points de vente actifs...';
                if (aiLoadingDetails) aiLoadingDetails.textContent = 'Analyse des ventes du jour...';
                
                // Extract PDV from already loaded sales data (from the page)
                let activePointsDeVente = [];
                
                // Try to get from global variable if exists (loaded by displaySalesData)
                if (typeof salesData !== 'undefined' && salesData && salesData.ventes) {
                    const pdvSet = new Set();
                    salesData.ventes.forEach(pdv => {
                        if (pdv.pointVente) {
                            pdvSet.add(pdv.pointVente);
                        }
                    });
                    activePointsDeVente = Array.from(pdvSet);
                    console.log('üìç Points de vente actifs trouv√©s depuis les donn√©es charg√©es:', activePointsDeVente);
                }
                
                // If still empty, try to extract from the DOM (sales cards displayed on page)
                if (activePointsDeVente.length === 0) {
                    const salesCards = document.querySelectorAll('[data-pdv]');
                    const pdvSet = new Set();
                    salesCards.forEach(card => {
                        const pdv = card.getAttribute('data-pdv');
                        if (pdv) pdvSet.add(pdv);
                    });
                    activePointsDeVente = Array.from(pdvSet);
                    console.log('üìç Points de vente actifs extraits du DOM:', activePointsDeVente);
                }
                
                // If still empty, fetch from API
                if (activePointsDeVente.length === 0) {
                    console.log('üì° R√©cup√©ration des ventes via API pour extraire les PDV...');
                    try {
                        const apiResponse = await fetch(`/api/ventes-date?date=${date}`, {
                            credentials: 'include'
                        });
                        
                        if (apiResponse.ok) {
                            const apiData = await apiResponse.json();
                            const pdvSet = new Set();
                            
                            if (apiData.ventes && Array.isArray(apiData.ventes)) {
                                apiData.ventes.forEach(vente => {
                                    // Normalize field - API may return either format
                                    const pdv = vente.pointVente ?? vente['Point de Vente'];
                                    if (pdv) {
                                        pdvSet.add(pdv);
                                    }
                                });
                            }
                            
                            activePointsDeVente = Array.from(pdvSet);
                            console.log('üìç Points de vente actifs depuis l\'API:', activePointsDeVente);
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Erreur r√©cup√©ration ventes:', error);
                    }
                }
                
                // Final fallback: use all known PDVs
                if (activePointsDeVente.length === 0) {
                    activePointsDeVente = ['Mbao', 'O.Foire', 'Keur Massar', 'Linguere', 'Dahra', 'Abattage', 'Sacre Coeur'];
                    console.log('üìç Utilisation des PDV connus en fallback:', activePointsDeVente);
                }
                
                // Step 2: Launch day-screening for each point de vente
                console.log('üìä √âtape 2: Lancement du day-screening pour chaque PDV...');
                if (btn) btn.innerHTML = '<i class="bi bi-hourglass-split"></i> R√©cup√©ration des commentaires...';
                if (aiLoadingText) aiLoadingText.textContent = 'R√©cup√©ration des commentaires clients...';
                if (aiLoadingDetails) aiLoadingDetails.textContent = `Analyse de ${activePointsDeVente.length} point(s) de vente...`;
                
                for (let i = 0; i < activePointsDeVente.length; i++) {
                    const pdv = activePointsDeVente[i];
                    try {
                        console.log(`üîç Day-screening pour ${pdv}...`);
                        if (aiLoadingDetails) aiLoadingDetails.textContent = `Analyse des clients de ${pdv} (${i + 1}/${activePointsDeVente.length})...`;
                        
                        // Check if already completed
                        const statusCheck = await fetch(`/api/day-screening/status?date=${date}&pointVente=${encodeURIComponent(pdv)}`, {
                            credentials: 'include'
                        });
                        
                        if (statusCheck.ok) {
                            const statusData = await statusCheck.json();
                            if (statusData.status === 'completed') {
                                console.log(`‚úÖ Day-screening d√©j√† termin√© pour ${pdv}`);
                                continue; // Skip, already completed
                            }
                        }
                        
                        // Launch screening
                        const screeningResponse = await fetch('/api/day-screening/start', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ 
                                date: date,
                                pointVente: pdv,
                                forceRefresh: false
                            })
                        });
                        
                        if (screeningResponse.ok) {
                            const screeningData = await screeningResponse.json();
                            console.log(`‚úÖ Day-screening lanc√© pour ${pdv}:`, screeningData.fromCache ? 'depuis cache' : 'nouvelle analyse');
                            
                            // Wait for completion if not from cache
                            if (!screeningData.fromCache) {
                                let attempts = 0;
                                const maxAttempts = 15; // Max 15 seconds per PDV
                                
                                while (attempts < maxAttempts) {
                                    await new Promise(resolve => setTimeout(resolve, 1000));
                                    
                                    const statusResponse = await fetch(`/api/day-screening/status?date=${date}&pointVente=${encodeURIComponent(pdv)}`, {
                                        credentials: 'include'
                                    });
                                    
                                    if (statusResponse.ok) {
                                        const statusData = await statusResponse.json();
                                        if (statusData.status === 'completed') {
                                            console.log(`‚úÖ Day-screening termin√© pour ${pdv}`);
                                            break;
                                        } else if (statusData.status === 'error') {
                                            console.warn(`‚ö†Ô∏è Erreur day-screening pour ${pdv}:`, statusData.error);
                                            break;
                                        }
                                    }
                                    
                                    attempts++;
                                }
                            }
                        } else {
                            console.warn(`‚ö†Ô∏è √âchec day-screening pour ${pdv}`);
                        }
                    } catch (error) {
                        console.error(`‚ùå Erreur day-screening pour ${pdv}:`, error);
                    }
                }
                
                // Step 3: Call AI interpretation
                console.log('ü§ñ √âtape 3: Lancement de l\'analyse IA...');
                if (btn) btn.innerHTML = '<i class="bi bi-robot"></i> Analyse IA en cours...';
                if (aiLoadingText) aiLoadingText.textContent = 'Analyse IA des ventes et commentaires...';
                if (aiLoadingDetails) aiLoadingDetails.textContent = 'G√©n√©ration de l\'interpr√©tation intelligente...';
                
                // Get selected model
                const selectedModel = document.getElementById('ai-model-select').value;
                console.log('ü§ñ Mod√®le s√©lectionn√©:', selectedModel);
                
                // Get threshold value
                threshold = parseFloat(document.getElementById('ai-threshold-input').value) || 50000;
                console.log(' Seuil gros client:', threshold, 'FCFA');
                
                // Get topN value
                topN = parseInt(document.getElementById('ai-top-clients-input').value) || 10;
                console.log('üèÜ Top clients:', topN);
                
                const response = await fetch('/api/sales-ai-interpretation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ 
                        date,
                        model: selectedModel,
                        threshold: threshold,
                        topN: topN
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ R√©sultat IA:', data);
                console.log('üß† Mod√®le utilis√©:', data.model);
                console.log('üí¨ Commentaires trouv√©s:', data.commentsSentiment?.totalComments || 0);
                console.log('üìä D√©tails commentaires:', data.commentsSentiment);
                
                if (!data.success) {
                    throw new Error(data.message || 'Erreur lors de l\'analyse');
                }
                
                // Store data for audio - Extract global first/last order times from all PDVs
                currentAIData = data;
                
                // Extract global order times from all PDVs for audio reading
                if (data.salesSummary && data.salesSummary.byPointVente) {
                    let earliestTime = null;
                    let latestTime = null;
                    
                    Object.values(data.salesSummary.byPointVente).forEach(pdvData => {
                        if (pdvData.firstOrderTime && (!earliestTime || pdvData.firstOrderTime < earliestTime)) {
                            earliestTime = pdvData.firstOrderTime;
                        }
                        if (pdvData.lastOrderTime && (!latestTime || pdvData.lastOrderTime > latestTime)) {
                            latestTime = pdvData.lastOrderTime;
                        }
                    });
                    
                    currentAIData.firstOrderTime = earliestTime;
                    currentAIData.lastOrderTime = latestTime;
                }
                
                // üíæ Save to session cache
                try {
                    sessionStorage.setItem(cacheKey, JSON.stringify(data));
                    console.log('üíæ Analyse sauvegard√©e en cache');
                    if (cacheInfo) cacheInfo.style.display = 'block';
                    if (btnForce) btnForce.style.display = 'inline-block';
                    const btnAiText = document.getElementById('btn-ai-text');
                    if (btnAiText) btnAiText.textContent = 'Afficher l\'Analyse';
                } catch (cacheError) {
                    console.warn('‚ö†Ô∏è Erreur sauvegarde cache:', cacheError);
                }
                
                // Display results
                displayAIResults(data);
                
            } catch (error) {
                console.error('‚ùå Erreur analyse IA:', error);
                alert(`Erreur lors de l'analyse IA: ${error.message}`);
            } finally {
                // Re-enable button
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-robot"></i> Lancer l\'Analyse IA';
                }
                if (loadingDiv) loadingDiv.style.display = 'none';
            }
        }
        
        // Toggle audio reading
        function toggleAudioReading() {
            try {
                if (isReading) {
                    stopAudioReading();
                } else {
                    startAudioReading();
                }
            } catch (error) {
                console.error('Erreur toggle audio:', error);
                isReading = false;
                updateAudioButton();
            }
        }
        
        // Convertir un nombre en texte fran√ßais
        function numberToFrench(n) {
            if (n === 0) return 'z√©ro';
            
            const units = ['', 'un', 'deux', 'trois', 'quatre', 'cinq', 'six', 'sept', 'huit', 'neuf'];
            const teens = ['dix', 'onze', 'douze', 'treize', 'quatorze', 'quinze', 'seize', 'dix-sept', 'dix-huit', 'dix-neuf'];
            const tens = ['', '', 'vingt', 'trente', 'quarante', 'cinquante', 'soixante', 'soixante', 'quatre-vingt', 'quatre-vingt'];
            
            function convertLessThan1000(num) {
                if (num === 0) return '';
                
                let result = '';
                
                // Centaines
                const hundreds = Math.floor(num / 100);
                if (hundreds > 0) {
                    if (hundreds === 1) {
                        result += 'cent';
                    } else {
                        result += units[hundreds] + ' cent';
                    }
                    if (num % 100 === 0 && hundreds > 1) result += 's';
                }
                
                num %= 100;
                if (num === 0) return result;
                
                if (result) result += ' ';
                
                // Dizaines et unit√©s
                if (num < 10) {
                    result += units[num];
                } else if (num < 20) {
                    result += teens[num - 10];
                } else {
                    const tensDigit = Math.floor(num / 10);
                    const unitsDigit = num % 10;
                    
                    if (tensDigit === 7 || tensDigit === 9) {
                        // 70-79 = soixante-dix, 90-99 = quatre-vingt-dix
                        const base = tensDigit === 7 ? 'soixante' : 'quatre-vingt';
                        const remainder = num - (tensDigit === 7 ? 60 : 80);
                        if (remainder < 10) {
                            result += base + '-' + units[remainder];
                        } else {
                            result += base + '-' + teens[remainder - 10];
                        }
                    } else if (tensDigit === 8) {
                        // 80-89 = quatre-vingts / quatre-vingt-un, etc.
                        result += 'quatre-vingt';
                        if (unitsDigit === 0) {
                            result += 's';
                        } else {
                            result += '-' + units[unitsDigit];
                        }
                    } else {
                        result += tens[tensDigit];
                        if (unitsDigit === 1 && tensDigit !== 8) {
                            result += ' et un';
                        } else if (unitsDigit > 1) {
                            result += '-' + units[unitsDigit];
                        }
                    }
                }
                
                return result;
            }
            
            if (n < 1000) {
                return convertLessThan1000(n);
            }
            
            let result = '';
            
            // Millions
            if (n >= 1000000) {
                const millions = Math.floor(n / 1000000);
                if (millions === 1) {
                    result += 'un million';
                } else {
                    result += convertLessThan1000(millions) + ' millions';
                }
                n %= 1000000;
            }
            
            // Milliers
            if (n >= 1000) {
                if (result) result += ' ';
                const thousands = Math.floor(n / 1000);
                if (thousands === 1) {
                    result += 'mille';
                } else {
                    result += convertLessThan1000(thousands) + ' mille';
                }
                n %= 1000;
            }
            
            // Reste
            if (n > 0) {
                if (result) result += ' ';
                result += convertLessThan1000(n);
            }
            
            return result;
        }
        
        // Helper function to format numbers for speech (convert numbers to French text)
        function formatNumberForSpeech(text) {
            // Guard against undefined/null/non-string values
            text = (text || '');
            // Coerce to string if not already
            text = String(text);
            
            // √âtape 0: Remplacer les nombres avec virgules (249,700) -> (249700)
            // Ex: "249,700 FCFA" -> "249700 FCFA" before processing
            text = text.replace(/(\d{1,3}),(\d{3})/g, '$1$2');
            
            // √âtape 1: Remplacer les nombres format√©s avec espaces suivis de FCFA
            // Ex: "24 800 FCFA" -> "vingt-quatre mille huit cents francs C.F.A."
            text = text.replace(/(\d{1,3}(?:[\s\u00A0]\d{3})*)\s*(?:FCFA|fcfa|Fcfa)/gi, (match, number) => {
                const cleanNumber = number.replace(/[\s\u00A0]/g, '');
                const numValue = parseInt(cleanNumber, 10);
                if (!isNaN(numValue)) {
                    const frenchNumber = numberToFrench(numValue);
                    // Utiliser "francs C.F.A." pour une meilleure prononciation
                    return `${frenchNumber} francs C.F.A.`;
                }
                return match;
            });
            
            // √âtape 2: Remplacer les nombres avec espaces (sans FCFA)
            // Ex: "24 800" -> "vingt-quatre mille huit cents"
            text = text.replace(/\b(\d{1,3}(?:[\s\u00A0]\d{3})+)\b/g, (match, number) => {
                const cleanNumber = number.replace(/[\s\u00A0]/g, '');
                const numValue = parseInt(cleanNumber, 10);
                if (!isNaN(numValue)) {
                    return numberToFrench(numValue);
                }
                return match;
            });
            
            // √âtape 3: Remplacer les grands nombres simples (sans espaces) >= 1000
            // Ex: "24800" -> "vingt-quatre mille huit cents"
            text = text.replace(/\b(\d{4,})\b/g, (match, number) => {
                const numValue = parseInt(number, 10);
                if (!isNaN(numValue) && numValue >= 1000) {
                    return numberToFrench(numValue);
                }
                return match;
            });
            
            return text;
        }
        
        // Start audio reading with ElevenLabs via backend
        async function startAudioReading() {
            if (!currentAIData) {
                alert('Aucune analyse disponible √† lire');
                return;
            }
            
            // Guard against rapid clicks
            if (isReading) {
                console.log('‚è∏Ô∏è Lecture d√©j√† en cours');
                return;
            }
            
            // Build text to read with natural pauses
            let textToRead = 'Bonjour. Voici l\'analyse globale des ventes.\n\n';
            textToRead += formatNumberForSpeech(currentAIData.globalInterpretation) + '.\n\n';
            
            // Add time info
            if (currentAIData.firstOrderTime && currentAIData.lastOrderTime) {
                textToRead += `Premi√®re commande re√ßue √† ${currentAIData.firstOrderTime}, `;
                textToRead += `et derni√®re commande √† ${currentAIData.lastOrderTime}.\n\n`;
            }
            
            // Add sentiment summary avec 5 humeurs
            const sentiment = currentAIData.sentimentSummary || {};
            if (sentiment.totalClients > 0) {
                const moods = sentiment.moods || {};
                const totalSatisfied = (moods.excellent || 0) + (moods.very_happy || 0) + (moods.happy || 0);
                const totalToWatch = (moods.unhappy || 0) + (moods.very_unhappy || 0);
                
                textToRead += `Concernant la satisfaction client: `;
                textToRead += `nous avons ${numberToFrench(totalSatisfied)} clients satisfaits, `;
                textToRead += `et ${numberToFrench(totalToWatch)} clients √† surveiller.\n\n`;
                
                // D√©tail si pertinent
                if (moods.excellent > 0) {
                    textToRead += `Parmi eux, ${numberToFrench(moods.excellent)} ont une note excellente. `;
                }
                if (moods.very_unhappy > 0) {
                    textToRead += `Attention: ${numberToFrench(moods.very_unhappy)} clients sont tr√®s insatisfaits.\n\n`;
                }
            }
            
            // Add comments sentiment analysis
            const commentsSentiment = currentAIData.commentsSentiment || {};
            if (commentsSentiment.totalComments > 0) {
                textToRead += `Passons maintenant aux commentaires clients.\n`;
                textToRead += `Nous avons analys√© ${numberToFrench(commentsSentiment.totalComments)} commentaires. `;
                const analysis = commentsSentiment.analysis || {};
                if (analysis.summary) {
                    textToRead += `${analysis.summary}. `;
                }
                if (analysis.overall) {
                    textToRead += `Le sentiment global est ${analysis.overall}.\n\n`;
                }
            }
            
            // Add payment statistics
            if (currentAIData.paymentStats) {
                textToRead += `Voici les statistiques de paiement:\n`;
                Object.entries(currentAIData.paymentStats).forEach(([status, stat]) => {
                    if (stat.count > 0) {
                        textToRead += `${numberToFrench(stat.count)} commandes ${stat.label.toLowerCase()}, `;
                        textToRead += `pour un total de ${formatNumberForSpeech(stat.amount + ' FCFA')}.\n`;
                    }
                });
                textToRead += '\n';
            }
            
            // Add commande insights
            if (currentAIData.commandeInsights) {
                const insights = currentAIData.commandeInsights;
                textToRead += `Concernant les commandes:\n`;
                textToRead += `La plus grosse commande s'√©l√®ve √† ${formatNumberForSpeech(insights.maxCommande.amount + ' FCFA')}`;
                if (insights.maxCommande.clientNom) {
                    textToRead += `, effectu√©e par ${insights.maxCommande.clientNom}`;
                }
                textToRead += `.\n`;
                if (insights.maxCommandeBelowThreshold.amount > 0) {
                    textToRead += `La plus grosse commande en dessous du seuil de ${formatNumberForSpeech(insights.threshold + ' FCFA')} `;
                    textToRead += `est de ${formatNumberForSpeech(insights.maxCommandeBelowThreshold.amount + ' FCFA')}`;
                    if (insights.maxCommandeBelowThreshold.clientNom) {
                        textToRead += `, pour ${insights.maxCommandeBelowThreshold.clientNom}`;
                    }
                    textToRead += `.\n\n`;
                }
            }
            
            // Add analysis by point de vente
            if (currentAIData.byPointVente) {
                textToRead += 'Voici maintenant l\'analyse par point de vente:\n\n';
                
                const salesByPdv = currentAIData.salesSummary?.byPointVente || {};
                
                Object.entries(currentAIData.byPointVente).forEach(([pdv, analysis]) => {
                    const sales = salesByPdv[pdv] || {};
                    
                    textToRead += `Point de vente ${pdv}:\n`;
                    
                    // Chiffre d'affaires et transactions
                    if (sales.totalAmount) {
                        const ca = `${sales.totalAmount} FCFA`;
                        textToRead += `Chiffre d'affaires: ${formatNumberForSpeech(ca)}, `;
                    }
                    if (sales.transactions) {
                        textToRead += `avec ${numberToFrench(sales.transactions)} ${sales.transactions > 1 ? 'transactions' : 'transaction'}, `;
                    }
                    if (sales.commandes) {
                        textToRead += `r√©parties en ${numberToFrench(sales.commandes)} ${sales.commandes > 1 ? 'commandes' : 'commande'}.\n`;
                    }
                    
                    // Panier moyen et plus grosse commande
                    if (sales.avgCommande) {
                        const avg = `${Math.round(sales.avgCommande)} FCFA`;
                        textToRead += `Panier moyen: ${formatNumberForSpeech(avg)}. `;
                    }
                    if (sales.maxCommande) {
                        const max = `${sales.maxCommande} FCFA`;
                        textToRead += `Plus grosse commande: ${formatNumberForSpeech(max)}`;
                        if (sales.maxCommandeClient?.nom) {
                            textToRead += `, effectu√©e par ${sales.maxCommandeClient.nom}`;
                        }
                        textToRead += '.\n';
                    }
                    
                    // Analyse qualitative de l'IA
                    textToRead += `${formatNumberForSpeech(analysis)}.\n\n`;
                });
            }
            
            // Conclusion
            textToRead += 'Fin de l\'analyse. Merci de votre attention.';
            
            try {
                // Update UI
                isReading = true;
                updateAudioButton();
                console.log('üîä D√©but de la lecture audio avec ElevenLabs');
                console.log('üìù Texte √† lire:', textToRead.substring(0, 100) + '...');
                
                // Call backend API for text-to-speech
                const response = await fetch('/api/realtime/text-to-speech', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        text: textToRead
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    
                    // Handle specific service unavailable case
                    if (response.status === 503) {
                        throw new Error(errorData.error || 'Service de synth√®se vocale non disponible');
                    }
                    
                    throw new Error(errorData.error || errorData.message || `Erreur serveur (${response.status})`);
                }
                
                // Convert response to blob
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                
                // Create and play audio element
                const audio = new Audio(audioUrl);
                window.currentAudio = audio; // Store for stopping
                
                audio.onended = function() {
                    isReading = false;
                    updateAudioButton();
                    URL.revokeObjectURL(audioUrl);
                    console.log('‚úÖ Fin de la lecture audio');
                };
                
                audio.onerror = function(error) {
                    isReading = false;
                    updateAudioButton();
                    URL.revokeObjectURL(audioUrl);
                    console.error('‚ùå Erreur lecture audio:', error);
                };
                
                await audio.play();
                
            } catch (error) {
                console.error('‚ùå Erreur ElevenLabs:', error);
                
                // Check if it's a quota error or service unavailable
                const isQuotaError = error.message.includes('quota') || error.message.includes('401');
                const isServiceUnavailable = error.message.includes('non disponible') || error.message.includes('503');
                
                if (isQuotaError || isServiceUnavailable) {
                    console.warn('‚ö†Ô∏è Basculement vers la synth√®se vocale du navigateur');
                    
                    // Fallback to browser's speech synthesis
                    try {
                        await startBrowserSpeech(textToRead);
                        return; // Success with fallback
                    } catch (fallbackError) {
                        console.error('‚ùå Erreur fallback:', fallbackError);
                        alert('Erreur : Service vocal premium indisponible et le navigateur ne supporte pas la synth√®se vocale.');
                    }
                } else {
                    alert('Erreur lors de la g√©n√©ration de l\'audio: ' + error.message);
                }
                
                isReading = false;
                updateAudioButton();
            }
        }
        
        // Fallback: Browser speech synthesis
        async function startBrowserSpeech(text) {
            return new Promise((resolve, reject) => {
                if (!('speechSynthesis' in window)) {
                    reject(new Error('Synth√®se vocale non support√©e par ce navigateur'));
                    return;
                }
                
                // Notify user of fallback
                console.log('üé§ Utilisation de la voix du navigateur (cr√©dits premium √©puis√©s)');
                
                // Cancel any ongoing speech
                window.speechSynthesis.cancel();
                
                // Split text into chunks (browsers have length limits)
                const maxLength = 200; // characters per utterance
                const sentences = text.split(/[.!?]\s+/);
                const chunks = [];
                let currentChunk = '';
                
                sentences.forEach(sentence => {
                    if ((currentChunk + sentence).length > maxLength) {
                        if (currentChunk) chunks.push(currentChunk);
                        currentChunk = sentence + '. ';
                    } else {
                        currentChunk += sentence + '. ';
                    }
                });
                if (currentChunk) chunks.push(currentChunk);
                
                let chunkIndex = 0;
                
                function speakNextChunk() {
                    if (chunkIndex >= chunks.length) {
                        isReading = false;
                        updateAudioButton();
                        console.log('‚úÖ Fin de la lecture audio (navigateur)');
                        resolve();
                        return;
                    }
                    
                    const utterance = new SpeechSynthesisUtterance(chunks[chunkIndex]);
                    
                    // Try to use French voice
                    const voices = window.speechSynthesis.getVoices();
                    const frenchVoice = voices.find(voice => voice.lang.startsWith('fr'));
                    if (frenchVoice) {
                        utterance.voice = frenchVoice;
                    }
                    
                    utterance.lang = 'fr-FR';
                    utterance.rate = 0.9; // Slightly slower for clarity
                    utterance.pitch = 1.0;
                    utterance.volume = 1.0;
                    
                    utterance.onend = function() {
                        chunkIndex++;
                        speakNextChunk();
                    };
                    
                    utterance.onerror = function(event) {
                        console.error('‚ùå Erreur lecture chunk:', event);
                        isReading = false;
                        updateAudioButton();
                        reject(new Error('Erreur lors de la lecture vocale'));
                    };
                    
                    window.speechSynthesis.speak(utterance);
                    window.currentSpeechUtterance = utterance;
                }
                
                // Load voices and start
                if (window.speechSynthesis.getVoices().length === 0) {
                    window.speechSynthesis.onvoiceschanged = () => {
                        speakNextChunk();
                    };
                } else {
                    speakNextChunk();
                }
            });
        }
        
        // Stop audio reading
        function stopAudioReading() {
            // Stop ElevenLabs audio if playing
            if (window.currentAudio) {
                window.currentAudio.pause();
                window.currentAudio.currentTime = 0;
            }
            
            // Stop browser speech synthesis if playing
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }
            try {
                if (window.currentAudio) {
                    window.currentAudio.pause();
                    window.currentAudio.currentTime = 0;
                    window.currentAudio = null;
                }
            } catch (error) {
                console.error('Erreur lors de l\'arr√™t audio:', error);
            }
            isReading = false;
            updateAudioButton();
            console.log('‚èπÔ∏è Lecture audio arr√™t√©e');
        }
        
        // Update audio button state
        function updateAudioButton() {
            try {
                const btn = document.getElementById('btn-audio-play');
                if (!btn) return;
                
                if (isReading) {
                    btn.innerHTML = '<i class="bi bi-stop-fill"></i> Arr√™ter';
                    btn.classList.remove('btn-outline-primary');
                    btn.classList.add('btn-danger');
                } else {
                    btn.innerHTML = '<i class="bi bi-volume-up-fill"></i> √âcouter';
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-outline-primary');
                }
            } catch (error) {
                console.error('Erreur update button:', error);
            }
        }
        
        function displayAIResults(data) {
            const resultsDiv = document.getElementById('ai-results');
            
            // Display model used
            const modelBadge = document.getElementById('ai-model-badge');
            if (data.model) {
                const modelNames = {
                    'gpt-4o-mini': 'GPT-4o Mini',
                    'gpt-4o': 'GPT-4o',
                    'gpt-4-turbo': 'GPT-4 Turbo',
                    'gpt-4': 'GPT-4'
                };
                modelBadge.textContent = `üß† ${modelNames[data.model] || data.model}`;
                modelBadge.style.display = 'inline-block';
            }
            
            // Display AI metrics (tokens & cost)
            const metricsDiv = document.getElementById('ai-metrics');
            if (data.aiMetrics) {
                const tokens = data.aiMetrics.tokens || {};
                const costEur = data.aiMetrics.cost?.eur || {};
                
                metricsDiv.innerHTML = `
                    <div class="d-flex gap-3 flex-wrap">
                        <span><i class="bi bi-arrow-down-circle"></i> <strong>${tokens.input?.toLocaleString() || 0}</strong> tokens input</span>
                        <span><i class="bi bi-arrow-up-circle"></i> <strong>${tokens.output?.toLocaleString() || 0}</strong> tokens output</span>
                        <span><i class="bi bi-calculator"></i> Total: <strong>${tokens.total?.toLocaleString() || 0}</strong> tokens</span>
                        <span><i class="bi bi-currency-euro"></i> Co√ªt: <strong>${(costEur.total || 0).toFixed(6)}‚Ç¨</strong></span>
                    </div>
                `;
            }
            
            // Global analysis
            document.getElementById('ai-global-analysis').textContent = data.globalInterpretation || 'Analyse non disponible';
            
            // Sentiment counts avec 5 niveaux d'humeurs
            const sentiment = data.sentimentSummary || {};
            const moods = sentiment.moods || {};
            
            // Mettre √† jour les 5 humeurs
            document.getElementById('ai-excellent-count').textContent = moods.excellent || 0;
            document.getElementById('ai-very-happy-count').textContent = moods.very_happy || 0;
            document.getElementById('ai-happy-count').textContent = moods.happy || 0;
            document.getElementById('ai-unhappy-count').textContent = moods.unhappy || 0;
            document.getElementById('ai-very-unhappy-count').textContent = moods.very_unhappy || 0;
            
            // Top Clients list
            const topClientsList = data.topClients || [];
            const topClientsDiv = document.getElementById('ai-top-clients');
            const topClientsListDiv = document.getElementById('ai-top-clients-list');
            
            if (topClientsList.length > 0) {
                topClientsDiv.style.display = 'block';
                topClientsListDiv.innerHTML = topClientsList.map((client, index) => {
                    const clientId = `client-${String(client.numeroClient || '').replace(/\D/g, '')}-${client.id || index}`;
                    
                    // Build orders details HTML
                    let ordersHTML = '';
                    if (client.commandes && client.commandes.length > 0) {
                        ordersHTML = client.commandes.map((commande, cmdIndex) => {
                            const produitsHTML = commande.produits.map(p => {
                                // Use prixUnit from database or calculate if not available
                                const quantite = p.quantite || 0;
                                const montant = p.montant || 0;
                                const prixUnitaire = p.prixUnit || (quantite > 0 ? Math.round(montant / quantite) : montant);
                                
                                return `
                                    <div class="d-flex justify-content-between align-items-center py-1" style="font-size: 13px;">
                                        <span>
                                            <strong>‚Ä¢ ${escapeHtml(p.produit)}</strong>
                                            <br>
                                            <span class="text-muted ms-3" style="font-size: 12px;">
                                                ${new Intl.NumberFormat('fr-FR').format(prixUnitaire)} FCFA √ó ${quantite}kg
                                            </span>
                                        </span>
                                        <strong class="text-success">${new Intl.NumberFormat('fr-FR').format(montant)} FCFA</strong>
                                    </div>
                                `;
                            }).join('');
                            
                            return `
                                <div class="mb-2 p-2 bg-white rounded border">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <small class="text-muted"><i class="bi bi-receipt"></i> ${escapeHtml(commande.commandeId)}</small>
                                        <strong class="text-success">${new Intl.NumberFormat('fr-FR').format(commande.montant)} FCFA</strong>
                                    </div>
                                    <div class="ps-2">
                                        ${produitsHTML}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                    
                    return `
                        <div class="mb-2 border border-success rounded" style="background: linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%);">
                            <div class="p-3" style="cursor: pointer;" onclick="toggleClientDetails('${clientId}')">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">
                                            <span class="badge bg-success me-2">#${index + 1}</span>
                                            <strong>üèÜ ${escapeHtml(client.nomClient)}</strong>
                                            <i class="bi bi-chevron-down ms-2" id="${clientId}-icon"></i>
                                        </h6>
                                        <div class="text-muted" style="font-size: 14px;">
                                            <i class="bi bi-telephone"></i> ${escapeHtml(client.numeroClient)}
                                            <span class="badge bg-primary ms-2">${escapeHtml(client.pointVente)}</span>
                                        </div>
                                    </div>
                                    <div class="text-end d-flex flex-column align-items-end gap-1">
                                        <h5 class="mb-0 text-success">${new Intl.NumberFormat('fr-FR').format(client.totalAmount)} FCFA</h5>
                                        <small class="text-muted">${client.commandesCount} commande(s)</small>
                                        ${client.numeroClient ? `
                                        <button onclick="event.stopPropagation(); ouvrirHistoriqueClientRealtime('${escapeHtml(client.numeroClient)}', '${escapeHtml(client.nomClient)}')"
                                            title="Voir l'historique complet du client"
                                            style="width:36px;height:36px;border-radius:8px;border:none;background:#9C27B0;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                                            <i class="fas fa-history"></i>
                                        </button>` : ''}
                                    </div>
                                </div>
                            </div>
                            <div id="${clientId}" class="px-3 pb-3" style="display: none;">
                                <hr class="my-2">
                                <h6 class="mb-2"><i class="bi bi-bag-check-fill"></i> D√©tails des Commandes</h6>
                                ${ordersHTML}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                topClientsDiv.style.display = 'none';
            }
            
            // Filter out "Client inconnu" from unhappy clients list
            const filteredUnhappyClients = (sentiment.unhappyClientsList || []).filter(client => {
                const clientName = (client.name || '').toLowerCase();
                return !clientName.includes('client inconnu') && !clientName.includes('inconnu');
            });
            
            // Unhappy clients list
            const unhappyDiv = document.getElementById('ai-unhappy-clients');
            const unhappyListDiv = document.getElementById('ai-unhappy-list');
            
            if (filteredUnhappyClients.length > 0) {
                unhappyDiv.style.display = 'block';
                unhappyListDiv.innerHTML = filteredUnhappyClients.map(client => {
                    const riskColor = client.riskLevel === 'high' ? 'danger' : 'warning';
                    const riskIcon = client.riskLevel === 'high' ? 'üî¥' : 'üü°';
                    const moodEmoji = client.mood === 'very_unhappy' ? 'üò°' : 'üò†';
                    
                    // Afficher la note moyenne
                    const ratingHtml = client.averageRating 
                        ? `<div class="mt-2 mb-2"><strong>‚≠ê Note: ${client.averageRating.toFixed(1)}/10</strong></div>` 
                        : '';
                    
                    // Afficher les derniers commentaires (max 3 les plus r√©cents)
                    let commentsHtml = '';
                    if (client.commentaires && client.commentaires.length > 0) {
                        const recentComments = client.commentaires.slice(0, 3);
                        commentsHtml = `
                            <div class="mt-2 mb-2">
                                <strong>üí¨ Derniers commentaires:</strong>
                                ${recentComments.map(c => `
                                    <div class="mt-1 p-2" style="background: white; border-left: 3px solid #f59e0b; border-radius: 4px; font-size: 12px;">
                                        <div class="text-muted" style="font-size: 10px;">${escapeHtml(c.date || 'Date inconnue')}</div>
                                        <div style="font-style: italic;">"${escapeHtml(c.comment)}"</div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    
                    return `
                        <div class="mb-3 p-3 border border-${riskColor} rounded" style="background: #fff3cd;">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <strong>${riskIcon} ${moodEmoji} ${escapeHtml(client.name)}</strong> 
                                    <span class="text-muted">(${escapeHtml(client.phone)})</span>
                                </div>
                                <span class="badge bg-${riskColor}">${escapeHtml(client.pointVente)}</span>
                            </div>
                            ${ratingHtml}
                            <div class="mt-1" style="font-size: 12px;">
                                ${client.alerts.map(a => `<div>‚Ä¢ ${escapeHtml(a)}</div>`).join('')}
                            </div>
                            ${commentsHtml}
                        </div>
                    `;
                }).join('');
            } else {
                unhappyDiv.style.display = 'none';
            }
            
            // Payment Statistics & Commande Insights - Removed (now shown per PDV only)
            // The global sections have been removed from the HTML
            
            // By Point de Vente
            const pdvDiv = document.getElementById('ai-pdv-analyses');
            const byPdv = data.byPointVente || {};
            const salesByPdv = data.salesSummary?.byPointVente || {};
            const sentimentByPdv = sentiment.byPointVente || {};
            
            pdvDiv.innerHTML = Object.keys(byPdv).map((pdv, index) => {
                const analysis = byPdv[pdv];
                const sales = salesByPdv[pdv] || {};
                const pdvSentiment = sentimentByPdv[pdv] || {};
                
                // Debug: Log client info
                console.log(`üë§ [${pdv}] maxCommandeBelowThresholdClient:`, sales.maxCommandeBelowThresholdClient);
                console.log(`üë§ [${pdv}] maxCommandeClient:`, sales.maxCommandeClient);
                console.log(`üë§ [${pdv}] minCommandeClient:`, sales.minCommandeClient);
                
                // Get all clients for this PDV grouped by mood
                const allClientsForPdv = (pdvSentiment.clients || []).filter(client => 
                    !((client.nomClient || '').toLowerCase().includes('client inconnu') || 
                      (client.nomClient || '').toLowerCase().includes('inconnu'))
                );
                
                // Create tooltips for each mood
                const createMoodTooltip = (moodType) => {
                    const clientsWithMood = allClientsForPdv.filter(c => c.mood === moodType);
                    if (clientsWithMood.length === 0) return 'Aucun client';
                    return clientsWithMood.map((client, idx) => {
                        const rating = client.averageRating ? ` (${client.averageRating.toFixed(1)}/10)` : '';
                        return `${idx + 1}. ${escapeHtml(client.nomClient || 'N/A')}<br>&nbsp;&nbsp;&nbsp;&nbsp;${escapeHtml(client.telephone || 'N/A')}${rating}`;
                    }).join('<br>');
                };
                
                const excellentTooltip = createMoodTooltip('excellent');
                const veryHappyTooltip = createMoodTooltip('very_happy');
                const happyTooltip = createMoodTooltip('happy');
                const unhappyTooltip = createMoodTooltip('unhappy');
                const veryUnhappyTooltip = createMoodTooltip('very_unhappy');
                
                const collapseId = `collapse-pdv-${index}`;
                
                // Top products
                const topProducts = sales.topProducts || [];
                const productsHtml = topProducts.slice(0, 3).map(([prod, count]) => 
                    `<span class="badge bg-secondary me-1">${escapeHtml(prod)}: ${count}</span>`
                ).join('');
                
                // Commande stats (min/max/avg)
                const commandeStatsHtml = sales.commandes > 0 
                    ? `<div class="mt-2">
                         <small class="text-muted">
                           Plus grosse commande: <strong>${new Intl.NumberFormat('fr-FR').format(sales.maxCommande || 0)} FCFA</strong> ‚Ä¢ 
                           Plus petite: <strong>${new Intl.NumberFormat('fr-FR').format(sales.minCommande || 0)} FCFA</strong> ‚Ä¢ 
                           Panier moyen: <strong>${new Intl.NumberFormat('fr-FR').format(sales.avgCommande || 0)} FCFA</strong>
                           ${sales.maxCommandeClient && (sales.maxCommandeClient.nom || sales.maxCommandeClient.numero) 
                               ? `<br><span style="font-size: 0.8rem;">üë§ Max: ${sales.maxCommandeClient.nom || 'N/A'}${sales.maxCommandeClient.numero ? ' - ' + sales.maxCommandeClient.numero : ''}</span>` 
                               : ''}
                           ${sales.minCommandeClient && (sales.minCommandeClient.nom || sales.minCommandeClient.numero) 
                               ? `<br><span style="font-size: 0.8rem;">üë§ Min: ${sales.minCommandeClient.nom || 'N/A'}${sales.minCommandeClient.numero ? ' - ' + sales.minCommandeClient.numero : ''}</span>` 
                               : ''}
                         </small>
                       </div>`
                    : '';
                
                // Payment stats badges (compact format)
                const paymentStatsHtml = sales.paymentStats && Object.keys(sales.paymentStats).length > 0
                    ? `<div class="mt-2">
                         ${Object.entries(sales.paymentStats).map(([status, stat]) => {
                             const statusIcons = { P: '‚úÖ', PP: '‚ö†Ô∏è', M: 'üíµ', O: 'üîì', C: 'üìã', A: '‚è≥', E: '‚ùå' };
                             const statusLabels = { P: 'Pay√©', PP: 'Part.Pay√©', M: 'Manuel', O: 'Ouvert', C: 'Cr√©dit', A: 'Attente', E: 'Expir√©' };
                             const statusColors = { P: 'success', PP: 'warning', M: 'info', O: 'primary', C: 'secondary', A: 'dark', E: 'danger' };
                             return `<span class="badge bg-${statusColors[status] || 'secondary'} me-1" style="font-size: 0.75rem;">
                                       ${statusIcons[status] || ''} ${stat.count} ${statusLabels[status] || status}
                                     </span>`;
                         }).join('')}
                       </div>`
                    : '';
                
                // Max commande below threshold (compact format) - always show
                const maxBelowThresholdHtml = sales.threshold 
                    ? `<div class="mt-2">
                         <small class="text-muted">
                           <i class="bi bi-star"></i> Plus grosse commande &lt; ${new Intl.NumberFormat('fr-FR').format(sales.threshold)} FCFA: 
                           ${sales.maxCommandeBelowThreshold && sales.maxCommandeBelowThreshold > 0 
                               ? `<strong>${new Intl.NumberFormat('fr-FR').format(sales.maxCommandeBelowThreshold)} FCFA</strong>
                                  ${sales.maxCommandeBelowThresholdStatus ? `<span class="badge bg-secondary ms-1" style="font-size: 0.65rem;">${sales.maxCommandeBelowThresholdStatus}</span>` : ''}
                                  ${sales.maxCommandeBelowThresholdClient && (sales.maxCommandeBelowThresholdClient.nom || sales.maxCommandeBelowThresholdClient.numero) 
                                      ? `<br><span style="font-size: 0.8rem;">üë§ ${sales.maxCommandeBelowThresholdClient.nom || 'N/A'}${sales.maxCommandeBelowThresholdClient.numero ? ' - ' + sales.maxCommandeBelowThresholdClient.numero : ''}</span>` 
                                      : ''}`
                               : `<span class="text-muted fst-italic">Aucune</span>`
                           }
                         </small>
                       </div>`
                    : '';
                
                // Time info for this PDV
                const timeInfo = sales.firstOrderTime && sales.lastOrderTime
                    ? `<div class="mt-2 pt-2" style="border-top: 1px dashed #dee2e6;">
                         <small class="text-muted">
                           <i class="bi bi-clock"></i> ${sales.firstOrderTime} 
                           <i class="bi bi-arrow-right"></i> 
                           <i class="bi bi-clock-fill"></i> ${sales.lastOrderTime}
                         </small>
                       </div>`
                    : '';
                
                return `
                    <div class="card mb-3" style="border-left: 4px solid #007bff; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div class="card-header" style="cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; user-select: none;" 
                             data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="bi bi-shop"></i> ${escapeHtml(pdv)}
                                    <span class="badge bg-light text-dark ms-2" style="font-weight: 600;">${new Intl.NumberFormat('fr-FR').format(sales.totalAmount || 0)} FCFA</span>
                                </h6>
                                <div>
                                    <small class="me-2" style="opacity: 0.8;">Cliquez pour replier</small>
                                    <i class="bi bi-chevron-down" style="font-size: 1.2rem;"></i>
                                </div>
                            </div>
                        </div>
                        <div id="${collapseId}" class="collapse show">
                            <div class="card-body">
                                <p class="card-text">${escapeHtml(analysis)}</p>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        üìä ${sales.transactions || 0} transactions ‚Ä¢ üì¶ ${sales.commandes || 0} commandes
                                        ${productsHtml ? '<br>' + productsHtml : ''}
                                    </small>
                                </div>
                                ${commandeStatsHtml}
                                ${paymentStatsHtml}
                                ${maxBelowThresholdHtml}
                                <div class="mt-2 d-flex gap-1 flex-wrap">
                                    ${(pdvSentiment.moods?.excellent || 0) > 0 ? `<span class="badge" style="background: #10b981; color: white; cursor: pointer;" 
                                          data-bs-toggle="tooltip" 
                                          data-bs-html="true"
                                          data-bs-placement="top"
                                          title="${excellentTooltip}"
                                          onclick="showMoodClients(${JSON.stringify(pdv).replace(/"/g, '&quot;')}, 'excellent', 'üíö', 'Excellent', '#10b981')">üíö ${pdvSentiment.moods.excellent}</span>` : ''}
                                    ${(pdvSentiment.moods?.very_happy || 0) > 0 ? `<span class="badge" style="background: #3b82f6; color: white; cursor: pointer;" 
                                          data-bs-toggle="tooltip" 
                                          data-bs-html="true"
                                          data-bs-placement="top"
                                          title="${veryHappyTooltip}"
                                          onclick="showMoodClients(${JSON.stringify(pdv).replace(/"/g, '&quot;')}, 'very_happy', 'üòä', 'Tr√®s satisfait', '#3b82f6')">üòä ${pdvSentiment.moods.very_happy}</span>` : ''}
                                    ${(pdvSentiment.moods?.happy || 0) > 0 ? `<span class="badge" style="background: #f59e0b; color: white; cursor: pointer;" 
                                          data-bs-toggle="tooltip" 
                                          data-bs-html="true"
                                          data-bs-placement="top"
                                          title="${happyTooltip}"
                                          onclick="showMoodClients(${JSON.stringify(pdv).replace(/"/g, '&quot;')}, 'happy', 'üòê', 'Satisfait', '#f59e0b')">üòê ${pdvSentiment.moods.happy}</span>` : ''}
                                    ${(pdvSentiment.moods?.unhappy || 0) > 0 ? `<span class="badge" style="background: #f97316; color: white; cursor: pointer;" 
                                          data-bs-toggle="tooltip" 
                                          data-bs-html="true"
                                          data-bs-placement="top"
                                          title="${unhappyTooltip}"
                                          onclick="showMoodClients(${JSON.stringify(pdv).replace(/"/g, '&quot;')}, 'unhappy', 'üò†', 'Insatisfait', '#f97316')">üò† ${pdvSentiment.moods.unhappy}</span>` : ''}
                                    ${(pdvSentiment.moods?.very_unhappy || 0) > 0 ? `<span class="badge" style="background: #ef4444; color: white; cursor: pointer;" 
                                          data-bs-toggle="tooltip" 
                                          data-bs-html="true"
                                          data-bs-placement="top"
                                          title="${veryUnhappyTooltip}"
                                          onclick="showMoodClients(${JSON.stringify(pdv).replace(/"/g, '&quot;')}, 'very_unhappy', 'üò°', 'Tr√®s insatisfait', '#ef4444')">üò° ${pdvSentiment.moods.very_unhappy}</span>` : ''}
                                    ${!pdvSentiment.moods || Object.values(pdvSentiment.moods).every(v => v === 0) ? `<span class="badge bg-secondary">üìä Aucune note disponible</span>` : ''}
                                </div>
                                ${timeInfo}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Initialize Bootstrap tooltips for unhappy clients badges
            setTimeout(() => {
                // Destroy existing tooltips first
                const existingTooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
                existingTooltips.forEach(el => {
                    const tooltip = bootstrap.Tooltip.getInstance(el);
                    if (tooltip) tooltip.dispose();
                });
                
                // Create new tooltips
                const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
                [...tooltipTriggerList].forEach(tooltipTriggerEl => {
                    new bootstrap.Tooltip(tooltipTriggerEl, {
                        html: true,
                        trigger: 'hover'
                    });
                });
                
                // Add event listeners for collapse animation
                const collapseHeaders = document.querySelectorAll('.card-header[data-bs-toggle="collapse"]');
                collapseHeaders.forEach(header => {
                    const targetId = header.getAttribute('data-bs-target');
                    const targetElement = document.querySelector(targetId);
                    
                    if (targetElement) {
                        targetElement.addEventListener('shown.bs.collapse', () => {
                            header.setAttribute('aria-expanded', 'true');
                        });
                        
                        targetElement.addEventListener('hidden.bs.collapse', () => {
                            header.setAttribute('aria-expanded', 'false');
                        });
                        
                        // Set initial state
                        if (targetElement.classList.contains('show')) {
                            header.setAttribute('aria-expanded', 'true');
                        } else {
                            header.setAttribute('aria-expanded', 'false');
                        }
                    }
                });
            }, 100);
            
            // Comments Sentiment Analysis
            const commentsSection = document.getElementById('ai-comments-section');
            const commentsSentiment = data.commentsSentiment || {};
            
            if (commentsSentiment.totalComments > 0) {
                commentsSection.style.display = 'block';
                
                const analysis = commentsSentiment.analysis || {};
                document.getElementById('ai-comments-total').textContent = commentsSentiment.totalComments || 0;
                document.getElementById('ai-comments-positive').textContent = analysis.positiveCount || 0;
                document.getElementById('ai-comments-negative').textContent = analysis.negativeCount || 0;
                document.getElementById('ai-comments-neutral').textContent = analysis.neutralCount || 0;
                
                // Overall sentiment badge
                const overallBadge = document.getElementById('ai-comments-overall');
                const overall = analysis.overall || 'non disponible';
                overallBadge.textContent = overall.toUpperCase();
                
                // Color based on sentiment
                overallBadge.className = 'badge ms-2 ';
                if (overall === 'positif') {
                    overallBadge.className += 'bg-success';
                } else if (overall === 'n√©gatif') {
                    overallBadge.className += 'bg-danger';
                } else if (overall === 'mixte') {
                    overallBadge.className += 'bg-warning text-dark';
                } else {
                    overallBadge.className += 'bg-secondary';
                }
                
                // Summary
                document.getElementById('ai-comments-summary').textContent = analysis.summary || 'Aucune analyse disponible';
                
                // Key themes
                if (analysis.keyThemes && analysis.keyThemes.length > 0) {
                    document.getElementById('ai-comments-themes').style.display = 'block';
                    document.getElementById('ai-comments-themes-list').innerHTML = analysis.keyThemes
                        .map(theme => `<span class="badge bg-light text-dark me-1">${escapeHtml(theme)}</span>`)
                        .join('');
                } else {
                    document.getElementById('ai-comments-themes').style.display = 'none';
                }
                
                // Comments list (afficher tous les commentaires directement, pas de bouton)
                const comments = commentsSentiment.comments || [];
                if (comments.length > 0) {
                    const listContent = document.getElementById('ai-comments-list-content');
                    listContent.innerHTML = comments.map(c => `
                        <div class="mb-2 pb-2" style="border-bottom: 1px solid #dee2e6;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>${escapeHtml(c.clientName || 'N/A')}</strong>
                                    <span class="text-muted ms-1">(${escapeHtml(c.clientPhone || 'N/A')})</span>
                                </div>
                                <div>
                                    <span class="badge bg-info">${escapeHtml(c.pointVente)}</span>
                                    ${c.date ? `<small class="text-muted ms-1">${escapeHtml(c.date)}</small>` : ''}
                                </div>
                            </div>
                            <div class="mt-1" style="font-size: 14px; color: #495057;">
                                üí¨ "${escapeHtml(c.comment)}"
                            </div>
                        </div>
                    `).join('');
                    
                    // Afficher la liste directement (pas masqu√©e)
                    const commentsList = document.getElementById('ai-comments-list');
                    commentsList.style.display = 'block';
                    
                    // Cacher le bouton toggle
                    const toggleBtn = commentsList.previousElementSibling;
                    if (toggleBtn && toggleBtn.querySelector('#comments-toggle-text')) {
                        toggleBtn.style.display = 'none';
                    }
                }
            } else {
                commentsSection.style.display = 'none';
            }
            
            // Show results
            resultsDiv.style.display = 'block';
        }
        
        // Toggle comments list visibility
        function toggleCommentsList() {
            const list = document.getElementById('ai-comments-list');
            const toggleText = document.getElementById('comments-toggle-text');
            
            if (list.style.display === 'none') {
                list.style.display = 'block';
                toggleText.textContent = 'Masquer les commentaires';
            } else {
                list.style.display = 'none';
                toggleText.textContent = 'Voir les commentaires';
            }
        }

        // Toggle top clients list
        function toggleTopClients() {
            const container = document.getElementById('ai-top-clients-container');
            const toggle = document.getElementById('top-clients-toggle');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                toggle.textContent = '‚ñ≤';
                toggle.classList.add('expanded');
            } else {
                container.style.display = 'none';
                toggle.textContent = '‚ñº';
                toggle.classList.remove('expanded');
            }
        }
        
        // Toggle individual client order details (accordion)
        function toggleClientDetails(clientId) {
            const detailsDiv = document.getElementById(clientId);
            const icon = document.getElementById(clientId + '-icon');
            
            if (detailsDiv.style.display === 'none') {
                detailsDiv.style.display = 'block';
                icon.classList.remove('bi-chevron-down');
                icon.classList.add('bi-chevron-up');
            } else {
                detailsDiv.style.display = 'none';
                icon.classList.remove('bi-chevron-up');
                icon.classList.add('bi-chevron-down');
            }
        }

        // Toggle unhappy clients list
        function toggleUnhappyClients() {
            const container = document.getElementById('ai-unhappy-list-container');
            const toggle = document.getElementById('unhappy-clients-toggle');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                toggle.textContent = '‚ñ≤';
                toggle.classList.add('expanded');
            } else {
                container.style.display = 'none';
                toggle.textContent = '‚ñº';
                toggle.classList.remove('expanded');
            }
        }

        // Afficher les clients d'une humeur dans la modal
        function showMoodClients(pdv, mood, moodEmoji, moodLabel, color) {
            console.log(`üìã Affichage des clients pour ${pdv} - ${mood}`);
            
            // R√©cup√©rer les donn√©es du sentiment pour ce PDV (m√™me structure que sentimentByPdv ailleurs)
            const sentimentData = currentAIData?.sentimentSummary?.byPointVente?.[pdv];
            if (!sentimentData || !sentimentData.clients) {
                console.warn('‚ö†Ô∏è Aucune donn√©e disponible pour ce PDV:', pdv);
                return;
            }

            // Filtrer les clients par humeur
            const clients = sentimentData.clients.filter(c => c.mood === mood);
            console.log(`üë• ${clients.length} client(s) trouv√©(s) pour ${mood}`);

            // Construire le contenu de la modal
            let html = '';
            if (clients.length === 0) {
                html = '<p class="text-muted">Aucun client trouv√© pour cette cat√©gorie.</p>';
            } else {
                html = '<div class="list-group">';
                clients.forEach(client => {
                    const rating = client.averageRating ? `‚≠ê ${client.averageRating.toFixed(1)}/10` : '';
                    html += `
                        <div class="list-group-item" style="border-left: 4px solid ${color};">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1"><strong>${escapeHtml(client.nomClient)}</strong></h6>
                                    <p class="mb-1 text-muted">
                                        <i class="bi bi-telephone"></i> ${escapeHtml(client.numeroClient)}
                                    </p>
                                </div>
                                <span class="badge" style="background: ${color}; color: white;">${rating}</span>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Mettre √† jour la modal
            document.getElementById('modal-mood-emoji').textContent = moodEmoji;
            document.getElementById('modal-mood-label').textContent = `${moodLabel} - ${pdv}`;
            document.getElementById('modal-clients-list').innerHTML = html;

            // Afficher la modal
            const modal = new bootstrap.Modal(document.getElementById('moodClientsModal'));
            modal.show();
        }

        // Export analysis to text file
        function exportAnalysisToText() {
            if (!currentAIData) {
                alert('Aucune analyse disponible √† exporter');
                return;
            }

            const date = getSelectedDate();
            const data = currentAIData;
            
            // Parse YYYY-MM-DD as local midnight (per timezone rules: avoid numeric Date constructor)
            const localDate = new Date(date + 'T00:00:00');
            
            // Build text content
            let text = '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            text += '          ANALYSE IA DES VENTES - KEUR BALLI\n';
            text += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            text += `Date: ${localDate.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}\n`;
            text += `G√©n√©r√© le: ${new Date().toLocaleString('fr-FR')}\n`;
            
            if (data.model) {
                const modelNames = {
                    'gpt-4o-mini': 'GPT-4o Mini',
                    'gpt-4o': 'GPT-4o',
                    'gpt-4': 'GPT-4'
                };
                text += `Mod√®le IA: ${modelNames[data.model] || data.model}\n`;
            }
            
            if (data.aiMetrics && data.aiMetrics.tokens) {
                const tokens = data.aiMetrics.tokens;
                const costEur = data.aiMetrics.cost?.eur || {};
                text += `Tokens utilis√©s: ${tokens.total?.toLocaleString() || 0} (${tokens.input?.toLocaleString() || 0} input + ${tokens.output?.toLocaleString() || 0} output)\n`;
                text += `Co√ªt: ${(costEur.total || 0).toFixed(6)}‚Ç¨\n`;
            }
            
            text += '\n' + '‚îÄ'.repeat(60) + '\n';
            text += 'üìä ANALYSE GLOBALE\n';
            text += '‚îÄ'.repeat(60) + '\n\n';
            text += (data.globalInterpretation || 'Non disponible') + '\n\n';
            
            // Time info
            if (data.firstOrderTime && data.lastOrderTime) {
                text += `‚è∞ Premi√®re commande: ${data.firstOrderTime}\n`;
                text += `‚è∞ Derni√®re commande: ${data.lastOrderTime}\n\n`;
            }
            
            // Sentiment summary avec 5 niveaux d'humeurs
            const sentiment = data.sentimentSummary || {};
            if (sentiment.totalClients > 0) {
                text += '‚îÄ'.repeat(60) + '\n';
                text += 'üé≠ HUMEURS CLIENTS (bas√© sur les notes)\n';
                text += '‚îÄ'.repeat(60) + '\n\n';
                text += `Total clients not√©s: ${sentiment.totalClients}\n\n`;
                
                // Afficher les 5 humeurs
                const moods = sentiment.moods || {};
                text += `üíö Excellent (> 9/10): ${moods.excellent || 0}\n`;
                text += `üòä Tr√®s satisfait (8-9/10): ${moods.very_happy || 0}\n`;
                text += `üòê Satisfait (7-8/10): ${moods.happy || 0}\n`;
                text += `üò† Insatisfait (6-7/10): ${moods.unhappy || 0}\n`;
                text += `üò° Tr√®s insatisfait (‚â§6/10): ${moods.very_unhappy || 0}\n\n`;
                
                // R√©sum√©
                const totalSatisfied = (moods.excellent || 0) + (moods.very_happy || 0) + (moods.happy || 0);
                const totalToWatch = (moods.unhappy || 0) + (moods.very_unhappy || 0);
                text += `‚úÖ Total satisfaits: ${totalSatisfied}\n`;
                text += `‚ö†Ô∏è Total √† surveiller: ${totalToWatch}\n\n`;
                
                // Unhappy clients details
                if (sentiment.unhappyClientsList && sentiment.unhappyClientsList.length > 0) {
                    text += '‚ö†Ô∏è Clients √† surveiller:\n\n';
                    sentiment.unhappyClientsList.forEach((client, index) => {
                        const moodEmoji = client.mood === 'very_unhappy' ? 'üò°' : 'üò†';
                        const rating = client.averageRating ? ` (${client.averageRating.toFixed(1)}/10)` : '';
                        text += `${index + 1}. ${moodEmoji} ${client.name} (${client.phone})${rating}\n`;
                        text += `   Point de vente: ${client.pointVente}\n`;
                        if (client.alerts && client.alerts.length > 0) {
                            text += `   Alertes:\n`;
                            client.alerts.forEach(alert => {
                                text += `   ‚Ä¢ ${alert}\n`;
                            });
                        }
                        text += '\n';
                    });
                }
            }
            
            // Comments sentiment
            const commentsSentiment = data.commentsSentiment || {};
            if (commentsSentiment.totalComments > 0) {
                text += '‚îÄ'.repeat(60) + '\n';
                text += 'üí¨ ANALYSE DES COMMENTAIRES CLIENTS\n';
                text += '‚îÄ'.repeat(60) + '\n\n';
                text += `Total commentaires: ${commentsSentiment.totalComments}\n`;
                
                const analysis = commentsSentiment.analysis || {};
                if (analysis.positiveCount !== undefined) {
                    text += `üòä Positifs: ${analysis.positiveCount}\n`;
                    text += `üòû N√©gatifs: ${analysis.negativeCount}\n`;
                    text += `üòê Neutres: ${analysis.neutralCount}\n`;
                }
                
                if (analysis.overall) {
                    text += `\nSentiment global: ${analysis.overall}\n`;
                }
                
                if (analysis.summary) {
                    text += `\nR√©sum√©: ${analysis.summary}\n`;
                }
                
                if (analysis.keyThemes && analysis.keyThemes.length > 0) {
                    text += `\nTh√®mes cl√©s:\n`;
                    analysis.keyThemes.forEach(theme => {
                        text += `‚Ä¢ ${theme}\n`;
                    });
                }
                text += '\n';
            }
            
            // Payment stats
            if (data.paymentStats) {
                text += '‚îÄ'.repeat(60) + '\n';
                text += 'üí≥ STATISTIQUES DE PAIEMENT (GLOBAL)\n';
                text += '‚îÄ'.repeat(60) + '\n\n';
                
                const statusLabels = {
                    P: 'Pay√©',
                    PP: 'Partiellement Pay√©',
                    M: 'Manuel (Cash)',
                    O: 'Ouvert',
                    C: 'Cr√©dit/Cr√©ance',
                    A: 'En Attente',
                    E: 'Expir√©'
                };
                
                Object.entries(data.paymentStats).forEach(([status, stat]) => {
                    if (stat.count > 0) {
                        text += `${statusLabels[status] || status}: ${stat.count} commande(s) - ${new Intl.NumberFormat('fr-FR').format(stat.amount)} FCFA\n`;
                    }
                });
                text += '\n';
            }
            
            // Commande insights
            if (data.commandeInsights) {
                const insights = data.commandeInsights;
                text += '‚îÄ'.repeat(60) + '\n';
                text += 'üèÜ ANALYSE DES COMMANDES (GLOBAL)\n';
                text += '‚îÄ'.repeat(60) + '\n\n';
                text += `Seuil gros client: ${new Intl.NumberFormat('fr-FR').format(insights.threshold)} FCFA\n`;
                text += `Total commandes: ${insights.totalCommandes}\n`;
                text += `Commandes ‚â• seuil: ${insights.commandesAboveThreshold}\n`;
                text += `Commandes < seuil: ${insights.commandesBelowThreshold}\n\n`;
                text += `üèÜ Plus grosse commande: ${new Intl.NumberFormat('fr-FR').format(insights.maxCommande.amount)} FCFA\n`;
                text += `   Commande #${insights.maxCommande.commandeId} - Statut: ${insights.maxCommande.status}\n`;
                if (insights.maxCommande.clientNom || insights.maxCommande.clientNumero) {
                    text += `   Client: ${insights.maxCommande.clientNom || 'N/A'}`;
                    if (insights.maxCommande.clientNumero) {
                        text += ` - ${insights.maxCommande.clientNumero}`;
                    }
                    text += '\n';
                }
                text += '\n';
                if (insights.maxCommandeBelowThreshold.amount > 0) {
                    text += `‚≠ê Plus grosse commande < seuil: ${new Intl.NumberFormat('fr-FR').format(insights.maxCommandeBelowThreshold.amount)} FCFA\n`;
                    text += `   Commande #${insights.maxCommandeBelowThreshold.commandeId} - Statut: ${insights.maxCommandeBelowThreshold.status}\n`;
                    if (insights.maxCommandeBelowThreshold.clientNom || insights.maxCommandeBelowThreshold.clientNumero) {
                        text += `   Client: ${insights.maxCommandeBelowThreshold.clientNom || 'N/A'}`;
                        if (insights.maxCommandeBelowThreshold.clientNumero) {
                            text += ` - ${insights.maxCommandeBelowThreshold.clientNumero}`;
                        }
                        text += '\n';
                    }
                }
                text += '\n';
            }
            
            // By Point de Vente
            if (data.byPointVente) {
                text += '‚ïê'.repeat(60) + '\n';
                text += 'üìç ANALYSE PAR POINT DE VENTE\n';
                text += '‚ïê'.repeat(60) + '\n\n';
                
                const salesByPdv = data.salesSummary?.byPointVente || {};
                const sentimentByPdv = sentiment.byPointVente || {};
                
                Object.keys(data.byPointVente).forEach((pdv, index) => {
                    const analysis = data.byPointVente[pdv];
                    const sales = salesByPdv[pdv] || {};
                    const pdvSentiment = sentimentByPdv[pdv] || {};
                    
                    text += `${index + 1}. ${pdv.toUpperCase()}\n`;
                    text += '‚îÄ'.repeat(60) + '\n\n';
                    
                    // Sales summary
                    text += ` Chiffre d'affaires: ${new Intl.NumberFormat('fr-FR').format(sales.totalAmount || 0)} FCFA\n`;
                    text += `üìä ${sales.transactions || 0} transactions\n`;
                    text += `üì¶ ${sales.commandes || 0} commande(s)\n\n`;
                    
                    // AI analysis
                    text += `Analyse: ${analysis}\n\n`;
                    
                    // Commande stats
                    if (sales.commandes > 0) {
                        text += `Plus grosse commande: ${new Intl.NumberFormat('fr-FR').format(sales.maxCommande || 0)} FCFA`;
                        if (sales.maxCommandeClient && (sales.maxCommandeClient.nom || sales.maxCommandeClient.numero)) {
                            text += ` - ${sales.maxCommandeClient.nom || 'N/A'}`;
                            if (sales.maxCommandeClient.numero) {
                                text += ` (${sales.maxCommandeClient.numero})`;
                            }
                        }
                        text += '\n';
                        text += `Plus petite commande: ${new Intl.NumberFormat('fr-FR').format(sales.minCommande || 0)} FCFA`;
                        if (sales.minCommandeClient && (sales.minCommandeClient.nom || sales.minCommandeClient.numero)) {
                            text += ` - ${sales.minCommandeClient.nom || 'N/A'}`;
                            if (sales.minCommandeClient.numero) {
                                text += ` (${sales.minCommandeClient.numero})`;
                            }
                        }
                        text += '\n';
                        text += `Panier moyen: ${new Intl.NumberFormat('fr-FR').format(sales.avgCommande || 0)} FCFA\n\n`;
                    }
                    
                    // Payment stats per PDV
                    if (sales.paymentStats && Object.keys(sales.paymentStats).length > 0) {
                        text += `Statuts de paiement:\n`;
                        Object.entries(sales.paymentStats).forEach(([status, stat]) => {
                            const statusLabels = { P: 'Pay√©', PP: 'Part.Pay√©', M: 'Manuel', O: 'Ouvert', C: 'Cr√©dit', A: 'Attente', E: 'Expir√©' };
                            text += `  ‚Ä¢ ${statusLabels[status] || status}: ${stat.count} (${new Intl.NumberFormat('fr-FR').format(stat.amount)} FCFA)\n`;
                        });
                        text += '\n';
                    }
                    
                    // Max commande below threshold per PDV
                    if (sales.threshold) {
                        text += `Plus grosse commande < ${new Intl.NumberFormat('fr-FR').format(sales.threshold)} FCFA: `;
                        if (sales.maxCommandeBelowThreshold && sales.maxCommandeBelowThreshold > 0) {
                            text += `${new Intl.NumberFormat('fr-FR').format(sales.maxCommandeBelowThreshold)} FCFA (${sales.maxCommandeBelowThresholdStatus})`;
                            if (sales.maxCommandeBelowThresholdClient && (sales.maxCommandeBelowThresholdClient.nom || sales.maxCommandeBelowThresholdClient.numero)) {
                                text += `\n  Client: ${sales.maxCommandeBelowThresholdClient.nom || 'N/A'}`;
                                if (sales.maxCommandeBelowThresholdClient.numero) {
                                    text += ` - ${sales.maxCommandeBelowThresholdClient.numero}`;
                                }
                            }
                            text += '\n\n';
                        } else {
                            text += `Aucune\n\n`;
                        }
                    }
                    
                    // Top products
                    if (sales.topProducts && sales.topProducts.length > 0) {
                        text += `Produits populaires:\n`;
                        sales.topProducts.slice(0, 5).forEach(([prod, count], i) => {
                            text += `  ${i + 1}. ${prod}: ${count}\n`;
                        });
                        text += '\n';
                    }
                    
                    // Humeurs (5 niveaux)
                    const pdvMoods = pdvSentiment.moods || {};
                    if (Object.values(pdvMoods).some(v => v > 0)) {
                        text += `\nHumeurs clients:\n`;
                        if (pdvMoods.excellent) text += `  üíö Excellent (> 9/10): ${pdvMoods.excellent}\n`;
                        if (pdvMoods.very_happy) text += `  üòä Tr√®s satisfait (8-9/10): ${pdvMoods.very_happy}\n`;
                        if (pdvMoods.happy) text += `  üòê Satisfait (7-8/10): ${pdvMoods.happy}\n`;
                        if (pdvMoods.unhappy) text += `  üò† Insatisfait (6-7/10): ${pdvMoods.unhappy}\n`;
                        if (pdvMoods.very_unhappy) text += `  üò° Tr√®s insatisfait (‚â§6/10): ${pdvMoods.very_unhappy}\n`;
                    } else {
                        text += `\nüìä Aucune note disponible pour ce point de vente\n`;
                    }
                    
                    // Time range
                    if (sales.firstOrderTime && sales.lastOrderTime) {
                        text += `‚è∞ ${sales.firstOrderTime} ‚Üí ${sales.lastOrderTime}\n`;
                    }
                    
                    text += '\n' + '‚ïê'.repeat(60) + '\n\n';
                });
            }
            
            text += '\n' + '‚îÄ'.repeat(60) + '\n';
            text += 'Fin du rapport - KEUR BALLI\n';
            text += '‚îÄ'.repeat(60) + '\n';
            
            // Create and download file
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `analyse-ia-${date}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('üìÑ Analyse export√©e en texte');
        }

        // ===== HISTORIQUE CLIENT (REALTIME) =====
        async function ouvrirHistoriqueClientRealtime(phoneNumber, clientName) {
            const modal = new bootstrap.Modal(document.getElementById('historiqueClientRealtimeModal'));
            
            // R√©initialiser l'affichage
            document.getElementById('histRt-nomClient').textContent = clientName || 'Client';
            document.getElementById('histRt-phone').textContent = phoneNumber || '-';
            document.getElementById('histRt-totalCommandes').textContent = '...';
            document.getElementById('histRt-firstOrder').textContent = '-';
            document.getElementById('histRt-lastOrder').textContent = '-';
            document.getElementById('histRt-loading').style.display = 'block';
            document.getElementById('histRt-content').style.display = 'none';
            document.getElementById('histRt-content').innerHTML = '';

            modal.show();

            try {
                const response = await fetch(`/api/audit-client?phone_number=${encodeURIComponent(phoneNumber)}`);
                if (!response.ok) throw new Error(`Erreur HTTP ${response.status}`);
                const data = await response.json();

                const clientInfo = data.client_info || {};
                const commandes = data.orders_history || [];

                // Stats
                document.getElementById('histRt-totalCommandes').textContent = `${clientInfo.total_orders || commandes.length} commande(s)`;
                document.getElementById('histRt-firstOrder').textContent = clientInfo.first_order
                    ? clientInfo.first_order.split('-').reverse().join('/') : '-';
                document.getElementById('histRt-lastOrder').textContent = clientInfo.last_order
                    ? clientInfo.last_order.split('-').reverse().join('/') : '-';

                // Commandes
                let html = '';
                if (commandes.length === 0) {
                    html = `<div class="text-center py-4 text-muted"><i class="bi bi-inbox fs-2"></i><p class="mt-2">Aucune commande trouv√©e</p></div>`;
                } else {
                    commandes.forEach(commande => {
                        const montant = parseFloat(commande.montant) || 0;
                        const borderColor = montant > 50000 ? '#16a34a' : montant > 20000 ? '#ea580c' : '#6b7280';
                        const date = commande.date || '-';
                        const pdv = commande.point_vente || '';
                        const destination = commande.destination || '';
                        const livreur = commande.livreur || '';
                        const commentaire = commande.commentaire || '';

                        html += `
                            <div class="mb-3 p-3 bg-white rounded shadow-sm" style="border-left: 4px solid ${borderColor};">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <div class="text-muted" style="font-size:12px;">üìÖ ${date}</div>
                                        <div class="fw-semibold">üìç ${pdv}</div>
                                        ${destination ? `<div class="text-muted" style="font-size:13px;">üéØ ${destination}</div>` : ''}
                                        ${livreur ? `<div style="font-size:12px; color:#7c3aed;">üöö ${livreur}</div>` : ''}
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-bold" style="color:${borderColor}; font-size:1.1rem;">${new Intl.NumberFormat('fr-FR').format(montant)} FCFA</div>
                                    </div>
                                </div>
                                ${commentaire ? `
                                    <div class="mt-2 p-2 rounded" style="background:#eff6ff; border-left:3px solid #3b82f6; font-size:13px;">
                                        üí¨ ${commentaire}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                }

                document.getElementById('histRt-content').innerHTML = html;
            } catch (err) {
                console.error('Erreur historique client:', err);
                document.getElementById('histRt-content').innerHTML = `
                    <div class="alert alert-danger m-3">
                        <i class="bi bi-exclamation-triangle-fill"></i> Impossible de charger l'historique. Veuillez r√©essayer.
                    </div>
                `;
            } finally {
                document.getElementById('histRt-loading').style.display = 'none';
                document.getElementById('histRt-content').style.display = 'block';
            }
        }

        // Nettoyer avant de quitter
        window.addEventListener('beforeunload', () => {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            if (countdownInterval) clearInterval(countdownInterval);
            // Stop audio if playing
            if (isReading) {
                stopAudioReading();
            }
        });
    </script>
</body>
</html>

