<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - Configuration Syst√®me</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a24;
            --bg-card: #16161f;
            --border-color: #2a2a3a;
            --border-active: #4a4a6a;
            --text-primary: #e8e8f0;
            --text-secondary: #a0a0b0;
            --text-muted: #606070;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --accent-info: #3b82f6;
            --gradient-1: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --gradient-2: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            background-image: 
                radial-gradient(ellipse at 20% 0%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(139, 92, 246, 0.06) 0%, transparent 50%);
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gradient-1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        /* Main Layout */
        .container {
            display: flex;
            min-height: calc(100vh - 65px);
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 1.5rem 1rem;
            position: sticky;
            top: 65px;
            height: calc(100vh - 65px);
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            padding-left: 0.75rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-primary);
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        /* Section */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--bg-tertiary);
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        tr:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-success);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-danger);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-warning);
        }

        .badge-info {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-info);
        }

        .badge-primary {
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-primary);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--gradient-1);
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
            border-color: var(--border-active);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: var(--accent-danger);
            color: white;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        .btn-icon {
            padding: 0.5rem;
            width: 36px;
            height: 36px;
            justify-content: center;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.9375rem;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        select.form-input {
            cursor: pointer;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .tab {
            padding: 0.625rem 1.25rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--accent-primary);
            color: white;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1.25rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* Actions */
        .actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Checkbox */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-primary);
            cursor: pointer;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .toast {
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-color: var(--accent-success);
        }

        .toast.error {
            border-color: var(--accent-danger);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.75rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Price input */
        .price-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .price-input-group .form-input {
            flex: 1;
        }

        .price-suffix {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>‚öôÔ∏è Configuration Syst√®me</h1>
        <div class="header-actions">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
                <span id="userName">Admin</span>
            </div>
            <a href="index.html" class="btn btn-secondary">‚Üê Retour</a>
        </div>
    </header>

    <div class="container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="nav-section">
                <div class="nav-section-title">Gestion</div>
                <div class="nav-item active" data-section="points-vente">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <span>Points de Vente</span>
                </div>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Catalogues</div>
                <div class="nav-item" data-section="produits-vente">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    <span>Produits Vente</span>
                </div>
                <div class="nav-item" data-section="produits-abonnement">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/>
                    </svg>
                    <span>Produits Abonnement</span>
                </div>
                <div class="nav-item" data-section="produits-inventaire">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                    <span>Produits Inventaire</span>
                </div>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Suivi</div>
                <div class="nav-item" data-section="historique">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>Historique Prix</span>
                </div>
                <!-- SUPPRIM√â - Stock unifi√© dans les fichiers JSON
                <div class="nav-item" data-section="stock-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                    <span>Stock Automatique</span>
                </div>
                -->
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Section Points de Vente -->
            <section class="section active" id="section-points-vente">
                <div class="section-header">
                    <h2 class="section-title">üìç Points de Vente</h2>
                    <button class="btn btn-primary" onclick="openPointVenteModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Ajouter
                    </button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>R√©f. Paiement</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="points-vente-table">
                            <tr><td colspan="4" class="loading"><div class="spinner"></div> Chargement...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Section Produits Vente -->
            <section class="section" id="section-produits-vente">
                <div class="section-header">
                    <h2 class="section-title">üõí Produits - Vente</h2>
                    <button class="btn btn-primary" onclick="openProduitModal('vente')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Ajouter
                    </button>
                </div>
                <div id="produits-vente-content"></div>
            </section>

            <!-- Section Produits Abonnement -->
            <section class="section" id="section-produits-abonnement">
                <div class="section-header">
                    <h2 class="section-title">üé´ Produits - Abonnement</h2>
                    <button class="btn btn-primary" onclick="openProduitModal('abonnement')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Ajouter
                    </button>
                </div>
                <div id="produits-abonnement-content"></div>
            </section>

            <!-- Section Produits Inventaire -->
            <section class="section" id="section-produits-inventaire">
                <div class="section-header">
                    <h2 class="section-title">üì¶ Produits - Inventaire</h2>
                    <button class="btn btn-primary" onclick="openProduitModal('inventaire')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Ajouter
                    </button>
                </div>
                <div id="produits-inventaire-content"></div>
            </section>

            <!-- Section Historique -->
            <section class="section" id="section-historique">
                <div class="section-header">
                    <h2 class="section-title">üìú Historique des Modifications de Prix</h2>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Produit</th>
                                <th>Point de Vente</th>
                                <th>Ancien Prix</th>
                                <th>Nouveau Prix</th>
                                <th>Modifi√© par</th>
                            </tr>
                        </thead>
                        <tbody id="historique-table">
                            <tr><td colspan="6" class="loading"><div class="spinner"></div> Chargement...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- SUPPRIM√â - Stock unifi√© dans les fichiers JSON
            Section Stock Automatique (lignes 804-848)
            -->
        </main>
    </div>

    <!-- Modal Point de Vente -->
    <div class="modal-overlay" id="point-vente-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="point-vente-modal-title">Nouveau Point de Vente</h3>
                <div class="modal-close" onclick="closeModal('point-vente-modal')">&times;</div>
            </div>
            <div class="modal-body">
                <form id="point-vente-form">
                    <input type="hidden" id="point-vente-id">
                    <div class="form-group">
                        <label class="form-label">Nom</label>
                        <input type="text" class="form-input" id="point-vente-nom" required>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-wrapper">
                            <input type="checkbox" id="point-vente-active" checked>
                            <span>Actif</span>
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('point-vente-modal')">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="savePointVente()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Modal Produit -->
    <div class="modal-overlay" id="produit-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="produit-modal-title">Nouveau Produit</h3>
                <div class="modal-close" onclick="closeModal('produit-modal')">&times;</div>
            </div>
            <div class="modal-body">
                <form id="produit-form">
                    <input type="hidden" id="produit-id">
                    <input type="hidden" id="produit-type-catalogue">
                    <div class="form-group">
                        <label class="form-label">Nom du produit</label>
                        <input type="text" class="form-input" id="produit-nom" required>
                    </div>
                    <div class="form-group" id="produit-categorie-group">
                        <label class="form-label">Cat√©gorie</label>
                        <select class="form-input" id="produit-categorie"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Prix par d√©faut (FCFA)</label>
                        <input type="number" class="form-input" id="produit-prix-defaut" min="0" step="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Prix alternatifs (s√©par√©s par des virgules)</label>
                        <input type="text" class="form-input" id="produit-prix-alternatifs" placeholder="3500, 3600, 3700">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('produit-modal')">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="saveProduit()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Modal Ajustement Stock -->
    <div class="modal-overlay" id="stock-ajust-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">üì¶ Ajustement du Stock</h3>
                <div class="modal-close" onclick="closeModal('stock-ajust-modal')">&times;</div>
            </div>
            <div class="modal-body">
                <form id="stock-ajust-form">
                    <input type="hidden" id="stock-ajust-id">
                    
                    <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--text-secondary);">Produit:</span>
                            <strong id="stock-ajust-produit">-</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--text-secondary);">Point de Vente:</span>
                            <strong id="stock-ajust-pv">-</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);">Stock Actuel:</span>
                            <strong id="stock-ajust-actuel" style="color: var(--accent-info);">-</strong>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Type d'ajustement</label>
                        <select class="form-input" id="stock-ajust-type" required>
                            <option value="">S√©lectionner...</option>
                            <option value="livraison">üì• Livraison (entr√©e)</option>
                            <option value="perte">üì§ Perte / Casse (sortie)</option>
                            <option value="inventaire">üìã Inventaire (correction)</option>
                            <option value="correction">üîß Correction manuelle</option>
                            <option value="transfert_entree">‚û°Ô∏è Transfert entrant</option>
                            <option value="transfert_sortie">‚¨ÖÔ∏è Transfert sortant</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Quantit√© √† ajouter/retirer</label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <input type="number" class="form-input" id="stock-ajust-quantite" step="0.1" required style="flex: 1;">
                            <span id="stock-ajust-unite" style="color: var(--text-secondary);">unit√©s</span>
                        </div>
                        <small style="color: var(--text-muted);">Nombre positif = ajout, Nombre n√©gatif = retrait</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Commentaire (obligatoire)</label>
                        <textarea class="form-input" id="stock-ajust-commentaire" rows="2" required placeholder="Raison de l'ajustement..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('stock-ajust-modal')">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="saveStockAjustement()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Modal Initialisation Stock -->
    <div class="modal-overlay" id="stock-init-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">üÜï Initialiser le Stock</h3>
                <div class="modal-close" onclick="closeModal('stock-init-modal')">&times;</div>
            </div>
            <div class="modal-body">
                <form id="stock-init-form">
                    <div class="form-group">
                        <label class="form-label">Produit (mode automatique)</label>
                        <select class="form-input" id="stock-init-produit" required>
                            <option value="">S√©lectionner un produit...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Point de Vente</label>
                        <select class="form-input" id="stock-init-pv" required>
                            <option value="">S√©lectionner...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Quantit√© initiale</label>
                        <input type="number" class="form-input" id="stock-init-quantite" step="0.1" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Prix unitaire (FCFA)</label>
                        <input type="number" class="form-input" id="stock-init-prix" step="1" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Commentaire</label>
                        <input type="text" class="form-input" id="stock-init-commentaire" placeholder="Stock initial...">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('stock-init-modal')">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="saveStockInit()">Initialiser</button>
            </div>
        </div>
    </div>

    <!-- Modal Historique Stock -->
    <div class="modal-overlay" id="stock-historique-modal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">üìú Historique des Ajustements</h3>
                <div class="modal-close" onclick="closeModal('stock-historique-modal')">&times;</div>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1rem;">
                    <strong id="stock-hist-produit">-</strong> @ <span id="stock-hist-pv">-</span>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Avant</th>
                                <th>+/-</th>
                                <th>Apr√®s</th>
                                <th>Par</th>
                            </tr>
                        </thead>
                        <tbody id="stock-historique-table">
                            <tr><td colspan="6">Chargement...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('stock-historique-modal')">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script>
        // Variables globales
        let pointsVenteList = [];
        let categoriesList = [];
        let currentSection = 'points-vente';

        // =====================================================
        // NAVIGATION
        // =====================================================
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const section = item.dataset.section;
                switchSection(section);
            });
        });

        function switchSection(section) {
            // Mettre √† jour la navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.section === section);
            });

            // Afficher la section
            document.querySelectorAll('.section').forEach(s => {
                s.classList.remove('active');
            });
            document.getElementById(`section-${section}`).classList.add('active');

            currentSection = section;

            // Charger les donn√©es
            loadSectionData(section);
        }

        function loadSectionData(section) {
            switch(section) {
                case 'points-vente':
                    loadPointsVente();
                    break;
                case 'produits-vente':
                    loadProduits('vente');
                    break;
                case 'produits-abonnement':
                    loadProduits('abonnement');
                    break;
                case 'produits-inventaire':
                    loadProduits('inventaire');
                    break;
                case 'historique':
                    loadHistorique();
                    break;
                case 'stock-auto':
                    chargerStockAuto();
                    break;
            }
        }

        // =====================================================
        // API CALLS
        // =====================================================
        async function apiCall(url, method = 'GET', body = null) {
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include'
            };
            if (body) options.body = JSON.stringify(body);

            const response = await fetch(url, options);
            const data = await response.json();

            if (!data.success) {
                throw new Error(data.error || 'Erreur inconnue');
            }

            return data;
        }

        // =====================================================
        // POINTS DE VENTE
        // =====================================================
        async function loadPointsVente() {
            try {
                const { data } = await apiCall('/api/admin/points-vente');
                pointsVenteList = data;
                renderPointsVenteTable(data);
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        function renderPointsVenteTable(pointsVente) {
            const tbody = document.getElementById('points-vente-table');
            if (!pointsVente || pointsVente.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty-state">Aucun point de vente</td></tr>';
                return;
            }

            tbody.innerHTML = pointsVente.map(pv => `
                <tr>
                    <td><strong>${pv.nom}</strong></td>
                    <td>
                        <input type="text" class="form-control form-control-sm" 
                               value="${pv.payment_ref || ''}" 
                               placeholder="Ex: V_KB"
                               style="width: 100px"
                               onchange="updatePaymentRef(${pv.id}, '${pv.nom}', this.value)">
                    </td>
                    <td><span class="badge ${pv.active ? 'badge-success' : 'badge-danger'}">${pv.active ? 'Actif' : 'Inactif'}</span></td>
                    <td class="actions">
                        <button class="btn btn-sm btn-secondary" onclick="editPointVente(${pv.id})">Modifier</button>
                        <button class="btn btn-sm btn-danger" onclick="deletePointVente(${pv.id}, '${pv.nom}')">Supprimer</button>
                    </td>
                </tr>
            `).join('');
        }

        function openPointVenteModal(pv = null) {
            document.getElementById('point-vente-modal-title').textContent = pv ? 'Modifier le point de vente' : 'Nouveau Point de Vente';
            document.getElementById('point-vente-id').value = pv?.id || '';
            document.getElementById('point-vente-nom').value = pv?.nom || '';
            document.getElementById('point-vente-active').checked = pv?.active !== false;
            document.getElementById('point-vente-modal').classList.add('active');
        }

        async function savePointVente() {
            const id = document.getElementById('point-vente-id').value;
            const data = {
                nom: document.getElementById('point-vente-nom').value,
                active: document.getElementById('point-vente-active').checked
            };

            try {
                if (id) {
                    await apiCall(`/api/admin/points-vente/${id}`, 'PUT', data);
                    showToast('Point de vente mis √† jour', 'success');
                } else {
                    await apiCall('/api/admin/points-vente', 'POST', data);
                    showToast('Point de vente cr√©√©', 'success');
                }
                closeModal('point-vente-modal');
                loadPointsVente();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function updatePaymentRef(id, nom, paymentRef) {
            try {
                await apiCall(`/api/admin/points-vente/${id}`, 'PUT', { 
                    nom, 
                    payment_ref: paymentRef 
                });
                showToast('R√©f√©rence de paiement mise √† jour', 'success');
            } catch (error) {
                showToast(error.message, 'error');
                loadPointsVente(); // Recharger pour annuler
            }
        }

        async function editPointVente(id) {
            const pv = pointsVenteList.find(p => p.id === id);
            if (pv) openPointVenteModal(pv);
        }

        async function deletePointVente(id, nom) {
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer le point de vente "${nom}" ?`)) return;

            try {
                await apiCall(`/api/admin/points-vente/${id}`, 'DELETE');
                showToast('Point de vente supprim√©', 'success');
                loadPointsVente();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // =====================================================
        // PRODUITS
        // =====================================================
        async function loadProduits(typeCatalogue) {
            const containerId = `produits-${typeCatalogue}-content`;
            const container = document.getElementById(containerId);
            container.innerHTML = '<div class="loading"><div class="spinner"></div> Chargement...</div>';

            try {
                // Charger les cat√©gories si n√©cessaire
                if (categoriesList.length === 0) {
                    try {
                        const catResponse = await apiCall('/api/admin/config/categories');
                        categoriesList = catResponse.data || [];
                    } catch (e) {
                        console.warn('Cat√©gories non disponibles:', e);
                        categoriesList = [];
                    }
                }

                let produits = [];
                
                if (typeCatalogue === 'inventaire') {
                    // Utiliser la route sp√©cifique pour l'inventaire
                    const response = await apiCall('/api/admin/config/produits-inventaire');
                    const inventaireData = response.produitsInventaire || {};
                    const categoriesPerso = response.categoriesPersonnalisees || [];
                    
                    // Convertir l'objet en tableau
                    for (const [key, value] of Object.entries(inventaireData)) {
                        // V√©rifier si c'est une cat√©gorie personnalis√©e
                        if (categoriesPerso.includes(key) || (typeof value === 'object' && !value.prixDefault)) {
                            // C'est une cat√©gorie, it√©rer ses produits
                            for (const [produitNom, config] of Object.entries(value)) {
                                if (typeof config === 'object' && config.prixDefault !== undefined) {
                                    produits.push({
                                        nom: produitNom,
                                        prix_defaut: config.prixDefault,
                                        prix_alternatifs: config.alternatives || [],
                                        mode_stock: config.mode_stock || 'manuel',
                                        unite_stock: config.unite_stock || 'unite',
                                        categorie_affichage: key,
                                        prixParPointVente: Object.entries(config)
                                            .filter(([k, v]) => !['prixDefault', 'alternatives', 'mode_stock', 'unite_stock'].includes(k))
                                            .map(([pvNom, prix]) => ({ pointVente: { nom: pvNom }, prix }))
                                    });
                                }
                            }
                        } else if (typeof value === 'object' && value.prixDefault !== undefined) {
                            // C'est un produit au niveau racine
                            produits.push({
                                nom: key,
                                prix_defaut: value.prixDefault,
                                prix_alternatifs: value.alternatives || [],
                                mode_stock: value.mode_stock || 'manuel',
                                unite_stock: value.unite_stock || 'unite',
                                categorie_affichage: null,
                                prixParPointVente: Object.entries(value)
                                    .filter(([k, v]) => !['prixDefault', 'alternatives', 'mode_stock', 'unite_stock'].includes(k))
                                    .map(([pvNom, prix]) => ({ pointVente: { nom: pvNom }, prix }))
                            });
                        }
                    }
                } else {
                    // Pour vente et abonnement, utiliser la route standard
                    const response = await apiCall(`/api/admin/config/produits?type_catalogue=${typeCatalogue}`);
                    const produitsData = response.produits || {};
                    
                    // Convertir l'objet structur√© par cat√©gories en tableau
                    for (const [catName, catProduits] of Object.entries(produitsData)) {
                        for (const [produitNom, config] of Object.entries(catProduits)) {
                            produits.push({
                                nom: produitNom,
                                categorie: { nom: catName },
                                prix_defaut: config.default,
                                prix_alternatifs: config.alternatives || [],
                                prixParPointVente: Object.entries(config)
                                    .filter(([k, v]) => !['default', 'alternatives'].includes(k))
                                    .map(([pvNom, prix]) => ({ pointVente: { nom: pvNom }, prix }))
                            });
                        }
                    }
                }
                
                renderProduitsTable(produits, typeCatalogue, container);
            } catch (error) {
                container.innerHTML = `<div class="empty-state">Erreur: ${error.message}</div>`;
            }
        }

        function renderProduitsTable(produits, typeCatalogue, container) {
            if (!produits || produits.length === 0) {
                container.innerHTML = '<div class="empty-state">Aucun produit dans ce catalogue</div>';
                return;
            }

            // Grouper par cat√©gorie si ce n'est pas l'inventaire
            if (typeCatalogue !== 'inventaire') {
                const grouped = {};
                produits.forEach(p => {
                    const cat = p.categorie?.nom || 'Sans cat√©gorie';
                    if (!grouped[cat]) grouped[cat] = [];
                    grouped[cat].push(p);
                });

                container.innerHTML = Object.entries(grouped).map(([catName, prods]) => `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">${catName}</h3>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Produit</th>
                                        <th>Prix par d√©faut</th>
                                        <th>Prix alternatifs</th>
                                        <th>Prix sp√©cifiques</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${prods.map(p => renderProduitRow(p, typeCatalogue)).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `).join('');
            } else {
                // Pour inventaire, grouper par cat√©gorie d'affichage
                const grouped = { 'üì¶ Produits Standard': [] };
                produits.forEach(p => {
                    const cat = p.categorie_affichage || 'üì¶ Produits Standard';
                    if (!grouped[cat]) grouped[cat] = [];
                    grouped[cat].push(p);
                });
                
                container.innerHTML = Object.entries(grouped).map(([catName, prods]) => `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">${catName}</h3>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Produit</th>
                                        <th>Mode Stock</th>
                                        <th>Unit√©</th>
                                        <th>Prix par d√©faut</th>
                                        <th>Prix sp√©cifiques</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${prods.map(p => renderProduitRowInventaire(p)).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        function renderProduitRowInventaire(produit) {
            const modeStock = produit.mode_stock || 'manuel';
            const uniteStock = produit.unite_stock || 'unite';
            const modeBadge = modeStock === 'automatique' 
                ? '<span class="badge badge-primary">‚ö° Auto</span>' 
                : '<span class="badge badge-secondary">üîß Manuel</span>';
            const uniteBadge = uniteStock === 'kilo' 
                ? '<span class="badge badge-info">kg</span>' 
                : '<span class="badge badge-secondary">unit√©</span>';
            
            const prixSpecifiques = produit.prixParPointVente?.map(ppv => 
                `${ppv.pointVente?.nom}: ${formatPrice(ppv.prix)}`
            ).join(', ') || '-';
            
            return `
                <tr>
                    <td><strong>${produit.nom}</strong></td>
                    <td>${modeBadge}</td>
                    <td>${uniteBadge}</td>
                    <td>${formatPrice(produit.prix_defaut)}</td>
                    <td><small>${prixSpecifiques}</small></td>
                    <td class="actions">
                        <button class="btn btn-sm btn-secondary" onclick="editProduitInventaire('${produit.nom}')">Modifier</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteProduit('${produit.nom}', 'inventaire')">Supprimer</button>
                    </td>
                </tr>`;
        }

        function renderProduitRow(produit, typeCatalogue) {
            const prixSpecifiques = produit.prixParPointVente?.map(pp => 
                `<span class="badge badge-info">${pp.pointVente?.nom}: ${formatPrice(pp.prix)}</span>`
            ).join(' ') || '-';

            return `
                <tr>
                    <td><strong>${produit.nom}</strong></td>
                    <td>${formatPrice(produit.prix_defaut)}</td>
                    <td>${produit.prix_alternatifs?.length > 0 ? produit.prix_alternatifs.map(p => formatPrice(p)).join(', ') : '-'}</td>
                    <td>${prixSpecifiques}</td>
                    <td class="actions">
                        <button class="btn btn-sm btn-secondary" onclick="editProduit(${produit.id}, '${typeCatalogue}')">Modifier</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteProduit(${produit.id}, '${produit.nom}', '${typeCatalogue}')">Supprimer</button>
                    </td>
                </tr>
            `;
        }

        async function openProduitModal(typeCatalogue, produit = null) {
            document.getElementById('produit-modal-title').textContent = produit ? 'Modifier le produit' : 'Nouveau Produit';
            document.getElementById('produit-id').value = produit?.id || '';
            document.getElementById('produit-type-catalogue').value = typeCatalogue;
            document.getElementById('produit-nom').value = produit?.nom || '';
            document.getElementById('produit-prix-defaut').value = produit?.prix_defaut || '';
            document.getElementById('produit-prix-alternatifs').value = produit?.prix_alternatifs?.join(', ') || '';

            // Afficher/masquer le select de cat√©gorie
            const catGroup = document.getElementById('produit-categorie-group');
            const catSelect = document.getElementById('produit-categorie');
            
            if (typeCatalogue === 'inventaire') {
                catGroup.style.display = 'none';
            } else {
                catGroup.style.display = 'block';
                catSelect.innerHTML = categoriesList.map(cat => 
                    `<option value="${cat.id}" ${produit?.categorie_id === cat.id ? 'selected' : ''}>${cat.nom}</option>`
                ).join('');
            }

            document.getElementById('produit-modal').classList.add('active');
        }

        async function saveProduit() {
            const id = document.getElementById('produit-id').value;
            const typeCatalogue = document.getElementById('produit-type-catalogue').value;
            
            const prixAlternatifs = document.getElementById('produit-prix-alternatifs').value
                .split(',')
                .map(p => parseFloat(p.trim()))
                .filter(p => !isNaN(p));

            const data = {
                nom: document.getElementById('produit-nom').value,
                type_catalogue: typeCatalogue,
                prix_defaut: parseFloat(document.getElementById('produit-prix-defaut').value) || 0,
                prix_alternatifs: prixAlternatifs
            };

            if (typeCatalogue !== 'inventaire') {
                data.categorie_id = parseInt(document.getElementById('produit-categorie').value);
            }

            try {
                if (id) {
                    await apiCall(`/api/admin/config/produits/${id}`, 'PUT', data);
                    showToast('Produit mis √† jour', 'success');
                } else {
                    await apiCall('/api/admin/config/produits', 'POST', data);
                    showToast('Produit cr√©√©', 'success');
                }
                closeModal('produit-modal');
                loadProduits(typeCatalogue);
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function editProduit(id, typeCatalogue) {
            try {
                const { data } = await apiCall(`/api/admin/produits/${id}`);
                openProduitModal(typeCatalogue, data);
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function deleteProduit(id, nom, typeCatalogue) {
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer le produit "${nom}" ?`)) return;

            try {
                await apiCall(`/api/admin/produits/${id}`, 'DELETE');
                showToast('Produit supprim√©', 'success');
                loadProduits(typeCatalogue);
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // =====================================================
        // HISTORIQUE
        // =====================================================
        async function loadHistorique() {
            try {
                const { data } = await apiCall('/api/admin/config/historique?limit=100');
                renderHistoriqueTable(data);
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        function renderHistoriqueTable(historique) {
            const tbody = document.getElementById('historique-table');
            if (!historique || historique.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Aucun historique</td></tr>';
                return;
            }

            tbody.innerHTML = historique.map(h => `
                <tr>
                    <td>${formatDate(h.createdAt)}</td>
                    <td><strong>${h.produit?.nom || '-'}</strong></td>
                    <td>${h.pointVente?.nom || '<em>Prix par d√©faut</em>'}</td>
                    <td>${h.ancien_prix ? formatPrice(h.ancien_prix) : '-'}</td>
                    <td>${formatPrice(h.nouveau_prix)}</td>
                    <td>${h.modifie_par || '-'}</td>
                </tr>
            `).join('');
        }

        // =====================================================
        // UTILS
        // =====================================================
        function formatPrice(price) {
            return new Intl.NumberFormat('fr-FR').format(price) + ' F';
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${type === 'success' ? '‚úÖ' : '‚ùå'}</span>
                <span>${message}</span>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Fermer modal avec Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });

        // Fermer modal en cliquant sur l'overlay
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        // =====================================================
        // STOCK AUTOMATIQUE
        // =====================================================
        let stockAutoData = [];

        async function chargerStockAuto() {
            const tbody = document.getElementById('stock-auto-table');
            tbody.innerHTML = '<tr><td colspan="8" class="loading"><div class="spinner"></div> Chargement...</td></tr>';
            
            try {
                // Charger les points de vente pour le filtre
                const pvResponse = await fetch('/api/points-vente', { credentials: 'include' });
                const pvData = await pvResponse.json();
                
                const filterPv = document.getElementById('stock-auto-filter-pv');
                filterPv.innerHTML = '<option value="">Tous les points de vente</option>';
                if (Array.isArray(pvData)) {
                    pvData.forEach(pv => {
                        filterPv.innerHTML += `<option value="${pv}">${pv}</option>`;
                    });
                }
                
                // Charger le stock
                const pointVenteFilter = filterPv.value;
                let url = '/api/stock-auto';
                if (pointVenteFilter) {
                    url += `?point_vente_id=${pointVenteFilter}`;
                }
                
                const response = await fetch(url, { credentials: 'include' });
                const data = await response.json();
                
                if (data.success) {
                    stockAutoData = data.data || [];
                    afficherStockAuto();
                } else {
                    tbody.innerHTML = `<tr><td colspan="8" style="color: var(--accent-danger);">Erreur: ${data.error}</td></tr>`;
                }
            } catch (error) {
                console.error('Erreur chargement stock auto:', error);
                tbody.innerHTML = `<tr><td colspan="8" style="color: var(--accent-danger);">Erreur: ${error.message}</td></tr>`;
            }
        }

        function afficherStockAuto() {
            const tbody = document.getElementById('stock-auto-table');
            
            if (!stockAutoData || stockAutoData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 2rem;">
                            <div style="color: var(--text-muted); margin-bottom: 1rem;">Aucun stock automatique configur√©</div>
                            <button class="btn btn-primary" onclick="openStockInitModal()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                Initialiser un stock
                            </button>
                        </td>
                    </tr>`;
                return;
            }
            
            let html = '';
            stockAutoData.forEach(stock => {
                const produit = stock.produit || {};
                const pv = stock.pointVente || {};
                const quantite = parseFloat(stock.quantite) || 0;
                const prixUnit = parseFloat(stock.prix_unitaire) || 0;
                const valeur = quantite * prixUnit;
                const unite = produit.unite_stock === 'kilo' ? 'kg' : 'unit√©s';
                
                // Badge pour stock n√©gatif
                const stockClass = quantite < 0 ? 'color: var(--accent-danger);' : '';
                const stockBadge = quantite < 0 ? '<span class="badge badge-danger" style="margin-left: 0.5rem;">N√©gatif</span>' : '';
                
                // Dernier ajustement
                let dernierAjust = '-';
                if (stock.dernier_ajustement_type && stock.dernier_ajustement_date) {
                    const date = new Date(stock.dernier_ajustement_date).toLocaleDateString('fr-FR');
                    dernierAjust = `${stock.dernier_ajustement_type} (${date})`;
                }
                
                html += `
                    <tr>
                        <td><strong>${produit.nom || '-'}</strong></td>
                        <td>${pv.nom || '-'}</td>
                        <td style="${stockClass}"><strong>${quantite.toFixed(produit.unite_stock === 'kilo' ? 2 : 0)}</strong>${stockBadge}</td>
                        <td>${unite}</td>
                        <td>${prixUnit.toLocaleString('fr-FR')} F</td>
                        <td style="${valeur < 0 ? 'color: var(--accent-danger);' : ''}">${valeur.toLocaleString('fr-FR')} F</td>
                        <td style="font-size: 0.8rem; color: var(--text-secondary);">${dernierAjust}</td>
                        <td>
                            <div style="display: flex; gap: 0.25rem;">
                                <button class="btn btn-sm btn-primary" onclick="openAjustementModal(${stock.id})" title="Ajuster">
                                    ¬±
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="voirHistorique(${stock.id})" title="Historique">
                                    üìú
                                </button>
                            </div>
                        </td>
                    </tr>`;
            });
            
            // Ajouter bouton pour initialiser un nouveau stock
            html += `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 1rem;">
                        <button class="btn btn-secondary" onclick="openStockInitModal()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            Ajouter un produit
                        </button>
                    </td>
                </tr>`;
            
            tbody.innerHTML = html;
        }

        function openAjustementModal(stockId) {
            const stock = stockAutoData.find(s => s.id === stockId);
            if (!stock) return;
            
            const produit = stock.produit || {};
            const pv = stock.pointVente || {};
            const unite = produit.unite_stock === 'kilo' ? 'kg' : 'unit√©s';
            
            document.getElementById('stock-ajust-id').value = stockId;
            document.getElementById('stock-ajust-produit').textContent = produit.nom || '-';
            document.getElementById('stock-ajust-pv').textContent = pv.nom || '-';
            document.getElementById('stock-ajust-actuel').textContent = `${parseFloat(stock.quantite).toFixed(2)} ${unite}`;
            document.getElementById('stock-ajust-unite').textContent = unite;
            document.getElementById('stock-ajust-type').value = '';
            document.getElementById('stock-ajust-quantite').value = '';
            document.getElementById('stock-ajust-commentaire').value = '';
            
            document.getElementById('stock-ajust-modal').classList.add('active');
        }

        async function saveStockAjustement() {
            const stockId = document.getElementById('stock-ajust-id').value;
            const type = document.getElementById('stock-ajust-type').value;
            const quantite = parseFloat(document.getElementById('stock-ajust-quantite').value);
            const commentaire = document.getElementById('stock-ajust-commentaire').value.trim();
            
            if (!type || isNaN(quantite) || !commentaire) {
                showToast('Veuillez remplir tous les champs', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/stock-auto/ajuster', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        stock_auto_id: parseInt(stockId),
                        type_ajustement: type,
                        quantite: quantite,
                        commentaire: commentaire
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Stock ajust√© avec succ√®s!', 'success');
                    closeModal('stock-ajust-modal');
                    chargerStockAuto();
                } else {
                    showToast('Erreur: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('Erreur: ' + error.message, 'error');
            }
        }

        async function openStockInitModal() {
            try {
                // Charger les produits en mode automatique
                const produitsResponse = await fetch('/api/stock-auto/produits-auto', { credentials: 'include' });
                const produitsData = await produitsResponse.json();
                
                const selectProduit = document.getElementById('stock-init-produit');
                selectProduit.innerHTML = '<option value="">S√©lectionner un produit...</option>';
                if (produitsData.success && produitsData.data) {
                    produitsData.data.forEach(p => {
                        const unite = p.unite_stock === 'kilo' ? '(kg)' : '(unit√©)';
                        selectProduit.innerHTML += `<option value="${p.id}" data-prix="${p.prix_defaut}" data-unite="${p.unite_stock}">${p.nom} ${unite}</option>`;
                    });
                }
                
                // Charger les points de vente
                const pvResponse = await fetch('/api/admin/points-vente', { credentials: 'include' });
                const pvData = await pvResponse.json();
                
                const selectPv = document.getElementById('stock-init-pv');
                selectPv.innerHTML = '<option value="">S√©lectionner...</option>';
                if (pvData.success && pvData.pointsVente) {
                    Object.entries(pvData.pointsVente).forEach(([nom, config]) => {
                        if (config.active) {
                            selectPv.innerHTML += `<option value="${config.id}">${nom}</option>`;
                        }
                    });
                }
                
                // R√©initialiser les champs
                document.getElementById('stock-init-quantite').value = '';
                document.getElementById('stock-init-prix').value = '';
                document.getElementById('stock-init-commentaire').value = 'Stock initial';
                
                // Listener pour pr√©-remplir le prix
                selectProduit.onchange = function() {
                    const option = this.options[this.selectedIndex];
                    if (option.dataset.prix) {
                        document.getElementById('stock-init-prix').value = option.dataset.prix;
                    }
                };
                
                document.getElementById('stock-init-modal').classList.add('active');
            } catch (error) {
                showToast('Erreur: ' + error.message, 'error');
            }
        }

        async function saveStockInit() {
            const produitId = document.getElementById('stock-init-produit').value;
            const pvId = document.getElementById('stock-init-pv').value;
            const quantite = parseFloat(document.getElementById('stock-init-quantite').value);
            const prix = parseFloat(document.getElementById('stock-init-prix').value) || 0;
            const commentaire = document.getElementById('stock-init-commentaire').value.trim();
            
            if (!produitId || !pvId || isNaN(quantite)) {
                showToast('Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/stock-auto/initialiser', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        produit_id: parseInt(produitId),
                        point_vente_id: parseInt(pvId),
                        quantite: quantite,
                        prix_unitaire: prix,
                        commentaire: commentaire
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Stock initialis√© avec succ√®s!', 'success');
                    closeModal('stock-init-modal');
                    chargerStockAuto();
                } else {
                    showToast('Erreur: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('Erreur: ' + error.message, 'error');
            }
        }

        async function voirHistorique(stockId) {
            const stock = stockAutoData.find(s => s.id === stockId);
            if (!stock) return;
            
            const produit = stock.produit || {};
            const pv = stock.pointVente || {};
            
            document.getElementById('stock-hist-produit').textContent = produit.nom || '-';
            document.getElementById('stock-hist-pv').textContent = pv.nom || '-';
            
            const tbody = document.getElementById('stock-historique-table');
            tbody.innerHTML = '<tr><td colspan="6">Chargement...</td></tr>';
            
            document.getElementById('stock-historique-modal').classList.add('active');
            
            try {
                const response = await fetch(`/api/stock-auto/historique/${stockId}`, { credentials: 'include' });
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    let html = '';
                    data.data.forEach(ajust => {
                        const date = new Date(ajust.date_ajustement).toLocaleDateString('fr-FR');
                        const diff = parseFloat(ajust.quantite_ajustee);
                        const diffClass = diff >= 0 ? 'color: var(--accent-success);' : 'color: var(--accent-danger);';
                        const diffText = diff >= 0 ? `+${diff.toFixed(2)}` : diff.toFixed(2);
                        
                        html += `
                            <tr>
                                <td>${date}</td>
                                <td>${ajust.type_ajustement}</td>
                                <td>${parseFloat(ajust.quantite_avant).toFixed(2)}</td>
                                <td style="${diffClass}"><strong>${diffText}</strong></td>
                                <td>${parseFloat(ajust.quantite_apres).toFixed(2)}</td>
                                <td style="font-size: 0.8rem;">${ajust.effectue_par}</td>
                            </tr>`;
                    });
                    tbody.innerHTML = html;
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-muted);">Aucun historique</td></tr>';
                }
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="6" style="color: var(--accent-danger);">Erreur: ${error.message}</td></tr>`;
            }
        }

        // =====================================================
        // INIT
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            loadPointsVente();
        });
    </script>
</body>
</html>

